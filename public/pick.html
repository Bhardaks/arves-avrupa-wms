
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Toplama</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
  <script src="/assets/js/smart-barcode-scanner.js"></script>
  <style>
    /* Mobile optimizations for pick page */
    @media (max-width: 768px) {
      .desktop-only {
        display: none !important;
      }
      
      .mobile-only {
        display: block !important;
      }
      
      .mobile-item-card {
        background: rgba(31,42,68,0.3);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .mobile-item-card:hover {
        background: rgba(31,42,68,0.5);
        border-color: var(--accent);
      }
      
      .mobile-item-card.completed {
        border-color: var(--success);
        background: rgba(34, 197, 94, 0.1);
      }
      
      .mobile-item-card.partial {
        border-color: var(--warning);
        background: rgba(251, 191, 36, 0.1);
      }
      
      .mobile-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .mobile-item-sku {
        font-weight: bold;
        color: var(--accent);
      }
      
      .mobile-item-status {
        font-size: 18px;
      }
      
      .mobile-item-name {
        font-weight: 500;
        margin-bottom: 8px;
      }
      
      .mobile-item-details {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 8px;
        font-size: 12px;
      }
      
      .mobile-item-detail {
        text-align: center;
        padding: 4px;
        background: rgba(0,0,0,0.2);
        border-radius: 4px;
      }
      
      .mobile-item-detail-label {
        color: var(--muted);
        display: block;
        margin-bottom: 2px;
      }
      
      .mobile-item-detail-value {
        font-weight: bold;
        color: var(--fg);
      }
      
    }
    
    @media (min-width: 769px) {
      .mobile-only {
        display: none !important;
      }
      
      .desktop-only {
        display: table !important;
      }
    }
    
    /* Package Location Styles */
    .package-locations {
      margin: 12px 0;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .locations-header {
      font-size: 12px;
      font-weight: bold;
      color: #4da3ff;
      margin-bottom: 8px;
      text-align: center;
    }
    
    .location-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      margin: 4px 0;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      font-size: 12px;
      position: relative;
    }
    
    .location-item.first-fifo {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid #22c55e;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
      70% { box-shadow: 0 0 0 5px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    
    .shelf-code {
      font-weight: bold;
      color: #4da3ff;
    }
    
    .shelf-info {
      color: #93a4bd;
      font-size: 11px;
    }
    
    .shelf-qty {
      background: #f59e0b;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: bold;
    }
    
    .fifo-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #22c55e;
      color: white;
      font-size: 8px;
      padding: 2px 4px;
      border-radius: 8px;
      font-weight: bold;
    }
    
    .no-locations {
      text-align: center;
      color: #ef4444;
      font-size: 12px;
      padding: 8px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 4px;
      margin: 8px 0;
    }
    
    /* Product color badge styles */
    .color-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      color: white;
      text-shadow: 0 1px 1px rgba(0,0,0,0.3);
      margin: 2px;
      min-width: 45px;
      text-align: center;
    }
    
    .color-badge.beyaz { background: linear-gradient(135deg, #f8f9fa, #e9ecef); color: #333; }
    .color-badge.siyah { background: linear-gradient(135deg, #343a40, #212529); }
    .color-badge.kahve { background: linear-gradient(135deg, #8b4513, #a0522d); }
    .color-badge.gri { background: linear-gradient(135deg, #6c757d, #495057); }
    .color-badge.antrasit { background: linear-gradient(135deg, #36454f, #2f3640); }
    .color-badge.mavi { background: linear-gradient(135deg, #007bff, #0056b3); }
    .color-badge.kirmizi { background: linear-gradient(135deg, #dc3545, #c82333); }
    .color-badge.yesil { background: linear-gradient(135deg, #28a745, #1e7e34); }
    .color-badge.sari { background: linear-gradient(135deg, #ffc107, #e0a800); color: #333; }
    .color-badge.pembe { background: linear-gradient(135deg, #e83e8c, #d91a72); }
    .color-badge.mor { background: linear-gradient(135deg, #6f42c1, #59359a); }
    .color-badge.turuncu { background: linear-gradient(135deg, #fd7e14, #e8590c); }
    .color-badge.default { background: linear-gradient(135deg, #6c757d, #5a6268); }
    
    /* Package content styling */
    .package-content {
      margin: 8px 0;
      padding: 6px 8px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      border-left: 3px solid rgba(255, 255, 255, 0.2);
    }
    
    .package-content small {
      color: #93a4bd;
      font-size: 11px;
      line-height: 1.3;
    }
  </style>
</head>
<body>
<header>
  <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;position:relative;">
    <h1>Toplama</h1>
    <button id="exitPick" class="exit-btn" title="Çıkış yapmak için tıklayın" style="background:#dc3545;color:white;padding:12px 24px;border:none;border-radius:6px;font-weight:bold;cursor:pointer;position:fixed;top:20px;right:20px;z-index:99999;box-shadow:0 4px 8px rgba(0,0,0,0.3);">Çıkış</button>
  </div>
</header>

<main style="max-width:1100px;margin:auto;padding:16px" class="grid">
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h2>Tarayıcı</h2>
      <div style="display:flex;gap:8px;">
        <div id="locationVerifyStatus" style="background:#dc3545;color:white;padding:8px 16px;border-radius:6px;display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:bold;" title="Lokasyon teyit modunu değiştirmek için tıklayın">
          <span id="locationVerifyIcon">🔒</span>
          <span id="locationVerifyText">Lokasyon Teyit: ZORUNLU</span>
        </div>
      </div>
    </div>
    <div class="flex" style="margin-top:16px;gap:12px;">
      <input id="manual" placeholder="Barkod girin... (sınırsız karakter)" class="scanner-input" style="flex:1;font-size:20px;padding:16px;text-align:center;" />
      <button id="enter" class="btn-large" style="background:#22c55e;color:white;min-width:120px;">Ekle</button>
    </div>
    <div class="grid" style="grid-template-columns: 1fr;">
      <div><strong>Son Okunan:</strong> <span id="last"></span></div>
    </div>
  </section>

  <section class="card">
    <h2>Sipariş Durumu</h2>
    <div id="orderInfo"></div>
    <div id="itemsContainer">
      <div id="mobileItems" class="mobile-only"></div>
      <table id="items" class="desktop-only"><thead><tr><th>SKU</th><th>Ürün</th><th>Renk</th><th>Paketler</th><th>Toplanan</th><th>Adet</th></tr></thead><tbody></tbody></table>
      <div id="packageDetails" class="package-details"></div>
    </div>
  </section>
</main>

<audio id="beepOk"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBYWFhYWFhAAAA" type="audio/wav"></audio>
<audio id="beepErr"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYBYWFhYWFhAAAA" type="audio/wav"></audio>

<script type="module">
const $ = (s)=>document.querySelector(s);
const url = new URL(location.href);
const pickId = url.searchParams.get('pick');
const externalOrderId = url.searchParams.get('external');

let pickData=null;
let currentlyViewedItemId = null; // Hangi item'ın package details'i açık

// Lokasyon teyit sistemi - Zorunlu
let locationVerificationEnabled = true; // Varsayılan olarak zorunlu açık
let pendingPackageBarcode = null;
let isWaitingForLocationScan = false;

// Color badge creation function
function createColorBadge(color) {
  if (!color) return '<span class="color-badge default">-</span>';
  
  const colorClass = color.toLowerCase()
    .replace('ı', 'i')
    .replace('ü', 'u')
    .replace('ğ', 'g')
    .replace('ş', 's')
    .replace('ç', 'c')
    .replace(/\s+/g, '');
  
  return `<span class="color-badge ${colorClass}">${color}</span>`;
}

async function loadPick(){
  // External order için özel işlem
  if(externalOrderId && !pickId){
    console.log('External order detected, creating pick for order:', externalOrderId);
    try {
      const response = await fetch('/api/picks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order_id: parseInt(externalOrderId, 10) })
      });
      
      if(!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      if(result.error) {
        alert('External pick oluşturma hatası: ' + result.error);
        return;
      }
      
      // Yeni oluşturulan pick ID ile sayfayı yenile
      window.location.href = `/pick.html?pick=${result.id}`;
      return;
    } catch (error) {
      console.error('External pick creation error:', error);
      alert('External pick oluşturulamadı: ' + error.message);
      return;
    }
  }

  if(!pickId){
    alert('Pick ID bulunamadı! URL\'de ?pick=X parametresi eksik.');
    return;
  }
  
  try {
    const r = await fetch('/api/picks/'+pickId);
    if(!r.ok) {
      throw new Error(`HTTP ${r.status}: ${r.statusText}`);
    }
    pickData = await r.json();
    
    if(!pickData.order) {
      throw new Error('Sipariş bilgisi bulunamadı');
    }
    
    $('#orderInfo').innerHTML = `
      <div><strong>Sipariş:</strong> ${pickData.order.order_number}</div>
      <div><strong>Müşteri:</strong> ${pickData.order.customer_name||'-'}</div>
      <div><strong>Durum:</strong> ${pickData.order.status}</div>
      <div><strong>Pick ID:</strong> ${pickData.pick.id}</div>
    `;
    
    const tb = $('#items tbody');
    
    if(!pickData.items || pickData.items.length === 0) {
      tb.innerHTML = '<tr><td colspan="5">Bu siparişte hiç kalem yok</td></tr>';
    } else {
      // Desktop table
      tb.innerHTML = pickData.items.map(it=>{
        const cls = (it.picked_qty>=it.quantity) ? 'completed' : (it.picked_qty > 0 ? 'partial' : '');
        const statusIcon = (it.picked_qty>=it.quantity) ? '✅' : (it.picked_qty > 0 ? '🔄' : '⏳');
        
        // Bu item için toplanan paket sayısını hesapla
        // picked_qty zaten tüm scan'ları (önceki + şu anki) include ediyor
        const totalPickedPackages = it.packages && it.packages.length > 0 
          ? it.picked_qty * it.packages.reduce((sum, pkg) => sum + (pkg.quantity || 1), 0)
          : it.picked_qty;
        
        // Bu item için toplam gerekli paket sayısını hesapla
        const totalRequiredPackages = it.packages 
          ? it.packages.reduce((sum, pkg) => sum + (pkg.quantity * it.quantity), 0)
          : 0;
        
        return `<tr class="${cls}" onclick="showPackageDetails(${it.id})" style="cursor: pointer;">
          <td>${statusIcon} ${it.sku}</td>
          <td>${it.product_name}</td>
          <td>${createColorBadge(it.product_color)}</td>
          <td><span class="package-count">${it.packages ? it.packages.length : 0} paket</span></td>
          <td class="picked-cell">
            ${totalRequiredPackages > 0 
              ? `<strong>${totalPickedPackages}/${totalRequiredPackages}</strong> paket`
              : `<strong>${it.picked_qty}</strong> set`
            }
          </td>
          <td class="quantity-cell">${it.quantity}</td>
        </tr>`
      }).join('');
      
      // Mobile cards
      const mobileContainer = $('#mobileItems');
      mobileContainer.innerHTML = pickData.items.map(it=>{
        const cls = (it.picked_qty>=it.quantity) ? 'completed' : (it.picked_qty > 0 ? 'partial' : '');
        const statusIcon = (it.picked_qty>=it.quantity) ? '✅' : (it.picked_qty > 0 ? '🔄' : '⏳');
        
        // Mobile için de aynı hesaplamayı yap
        // picked_qty zaten tüm scan'ları include ediyor
        const totalPickedPackages = it.packages && it.packages.length > 0 
          ? it.picked_qty * it.packages.reduce((sum, pkg) => sum + (pkg.quantity || 1), 0)
          : it.picked_qty;
        
        const totalRequiredPackages = it.packages 
          ? it.packages.reduce((sum, pkg) => sum + (pkg.quantity * it.quantity), 0)
          : 0;
        
        return `<div class="mobile-item-card ${cls}" onclick="showPackageDetails(${it.id})">
          <div class="mobile-item-header">
            <div class="mobile-item-sku">${it.sku}</div>
            <div class="mobile-item-status">${statusIcon}</div>
          </div>
          <div class="mobile-item-name">${it.product_name}</div>
          <div class="mobile-item-details">
            <div class="mobile-item-detail">
              <span class="mobile-item-detail-label">Renk</span>
              <span class="mobile-item-detail-value">${createColorBadge(it.product_color)}</span>
            </div>
            <div class="mobile-item-detail">
              <span class="mobile-item-detail-label">Paketler</span>
              <span class="mobile-item-detail-value">${it.packages ? it.packages.length : 0}</span>
            </div>
            <div class="mobile-item-detail">
              <span class="mobile-item-detail-label">Toplanan</span>
              <span class="mobile-item-detail-value">
                ${totalRequiredPackages > 0 
                  ? `${totalPickedPackages}/${totalRequiredPackages}`
                  : it.picked_qty
                }
              </span>
            </div>
            <div class="mobile-item-detail">
              <span class="mobile-item-detail-label">Adet</span>
              <span class="mobile-item-detail-value">${it.quantity}</span>
            </div>
          </div>
        </div>`
      }).join('');
    }
  } catch(error) {
    console.error('Pick yükleme hatası:', error);
    alert('Pick yüklenemedi: ' + error.message);
    $('#orderInfo').innerHTML = '<div style="color:red">Hata: Pick yüklenemedi</div>';
  }
}

// Ultra-aggressive anti-duplicate system
let lastScannedBarcode = '';
let lastScanTime = 0;
let isProcessingScan = false; // Processing flag to prevent multiple concurrent scans
let scanRequestId = 0; // Request ID to track scan requests
const SCAN_THROTTLE_MS = 3000; // 3 saniye throttle (increased from 2s)
const GLOBAL_SCAN_LOCK = { locked: false }; // Global lock object

async function submitBarcode(code){
  
  // Ultra-aggressive duplicate prevention
  const currentRequestId = ++scanRequestId;
  const currentTime = Date.now();
  
  // Global lock check
  if (GLOBAL_SCAN_LOCK.locked) {
    console.log('🚫 Global scan lock active, tarama engellendi:', code, 'RequestID:', currentRequestId);
    return;
  }
  
  // Prevent concurrent processing
  if (isProcessingScan) {
    console.log('🚫 İşlem devam ediyor, tarama engellendi:', code, 'RequestID:', currentRequestId);
    return;
  }
  
  // Enhanced throttling - Same barcode within throttle period
  if (code === lastScannedBarcode && (currentTime - lastScanTime) < SCAN_THROTTLE_MS) {
    console.log('🚫 Çoklu tarama engellendi (throttle):', code, 'RequestID:', currentRequestId, 'TimeDiff:', currentTime - lastScanTime + 'ms');
    return;
  }
  
  // Set global lock and processing flags
  GLOBAL_SCAN_LOCK.locked = true;
  isProcessingScan = true;
  lastScannedBarcode = code;
  lastScanTime = currentTime;
  
  console.log('✅ Tarama işlemi başlatıldı:', code, 'RequestID:', currentRequestId);
  
  try {
    // Lokasyon teyit modunda lokasyon taraması bekleniyor
    if (isWaitingForLocationScan) {
      await handleLocationScan(code);
      return;
    }
    
    // Lokasyon teyit modu açıksa ve bu bir ürün barkodu
    if (locationVerificationEnabled) {
      pendingPackageBarcode = code;
      isWaitingForLocationScan = true;
      
      // Input placeholder'ını değiştir ve görsel feedback ver
      $('#manual').placeholder = 'Şimdi raf barkodunu okutun (lokasyon teyit)';
      $('#manual').style.background = '#fff3cd';
      $('#manual').style.border = '2px solid #f0ad4e';
      
      // Kullanıcıya bilgi ver
      $('#last').textContent = `📦 Paket: ${code} → 📍 Raf barkodunu okutun`;
      $('#last').style.color = 'orange';
      $('#last').style.fontWeight = 'bold';
      
      return;
    }
    
    // Normal tarama modu
    const r = await fetch('/api/picks/'+pickId+'/scan', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ barcode: code })
    });
    const res = await r.json();
    
    if(res.success){
      $('#last').textContent = code;
      document.getElementById('beepOk').play().catch(()=>{});
      
      // Hemen görsel feedback göster
      $('#last').style.color = 'var(--success)';
      $('#last').style.fontWeight = 'bold';
      setTimeout(() => {
        $('#last').style.color = '';
        $('#last').style.fontWeight = '';
      }, 2000);
      
      await loadPick();
      
      // Eğer package details açıksa otomatik yenile
      if(currentlyViewedItemId) {
        showPackageDetails(currentlyViewedItemId);
      }
      
      if(res.order_completed){
        showOrderCompletedModal();
      }
    } else {
      document.getElementById('beepErr').play().catch(()=>{});
      alert(res.error || 'Hata');
    }
  } finally {
    // Always reset the processing flags and global lock
    isProcessingScan = false;
    GLOBAL_SCAN_LOCK.locked = false;
    console.log('🔓 Tarama kilidi serbest bırakıldı, RequestID:', currentRequestId);
  }
}

// Location scan throttling - Ultra-aggressive
let isProcessingLocationScan = false;
let locationRequestId = 0;
let lastLocationScanTime = 0;
const LOCATION_THROTTLE_MS = 3000;
const GLOBAL_LOCATION_LOCK = { locked: false };

// Lokasyon teyit fonksiyonu
async function handleLocationScan(shelfCode) {
  const currentLocationRequestId = ++locationRequestId;
  const currentTime = Date.now();
  
  // Global location lock check
  if (GLOBAL_LOCATION_LOCK.locked) {
    console.log('🚫 Global location lock active, lokasyon tarama engellendi:', shelfCode, 'RequestID:', currentLocationRequestId);
    return;
  }
  
  // Prevent concurrent location scans
  if (isProcessingLocationScan) {
    console.log('🚫 Lokasyon teyit işlemi devam ediyor, tarama engellendi:', shelfCode, 'RequestID:', currentLocationRequestId);
    return;
  }
  
  // Location-specific throttling
  if (currentTime - lastLocationScanTime < LOCATION_THROTTLE_MS) {
    console.log('🚫 Lokasyon tarama throttle aktif:', shelfCode, 'RequestID:', currentLocationRequestId, 'TimeDiff:', currentTime - lastLocationScanTime + 'ms');
    return;
  }
  
  // Set locks
  GLOBAL_LOCATION_LOCK.locked = true;
  isProcessingLocationScan = true;
  lastLocationScanTime = currentTime;
  
  console.log('✅ Lokasyon teyit işlemi başlatıldı:', shelfCode, 'RequestID:', currentLocationRequestId);
  
  try {
    // Lokasyon teyit API'sini çağır
    const response = await fetch(`/api/picks/${pickId}/verify-location`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ 
        packageBarcode: pendingPackageBarcode,
        shelfCode: shelfCode
      })
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      // Teyit sonucunu göster
      if (result.isCorrectLocation) {
        // Doğru lokasyon
        $('#last').textContent = `✅ ${result.message}`;
        $('#last').style.color = '#22c55e';
        
        // Başarılı teyit sonrası normal taramaya geç
        await processVerifiedScan(pendingPackageBarcode, shelfCode);
      } else {
        // Yanlış lokasyon - Zorunlu modda ret et
        $('#last').textContent = `❌ ${result.message}`;
        $('#last').style.color = '#dc3545';
        $('#last').style.fontWeight = 'bold';
        
        // Hata sesini çal
        document.getElementById('beepErr').play().catch(()=>{});
        
        // Zorunlu modda ret mesajı göster
        alert(`❌ LOKASYON HATASI - İŞLEM REDDEDİLDİ\n\n🔍 Beklenen Raf: ${result.expectedLocation.shelf_code}\n📍 Taranan Raf: ${shelfCode}\n\n⚠️ Lokasyon teyit zorunlu modda olduğu için yanlış raf girişi kabul edilmez.\n\n✅ Lütfen doğru rafı tarayın: ${result.expectedLocation.shelf_code}`);
        
        // Tarama durumunu sıfırla ve tekrar denemeye hazırla
        resetLocationVerification();
        return;
      }
    } else {
      throw new Error(result.error || 'Lokasyon teyit hatası');
    }
    
  } catch (error) {
    console.error('Location verification error:', error);
    alert('Lokasyon teyidi başarısız: ' + error.message);
    resetLocationVerification();
  } finally {
    // Always reset the processing flags and global lock
    isProcessingLocationScan = false;
    GLOBAL_LOCATION_LOCK.locked = false;
    console.log('🔓 Lokasyon teyit kilidi serbest bırakıldı, RequestID:', currentLocationRequestId);
  }
}

// Teyit edilmiş taramayı işle
async function processVerifiedScan(packageBarcode, shelfCode, isCorrectLocation = true) {
  try {
    const r = await fetch('/api/picks/'+pickId+'/scan', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ 
        barcode: packageBarcode,
        verifiedLocation: {
          shelfCode: shelfCode,
          isCorrectLocation: isCorrectLocation
        }
      })
    });
    const res = await r.json();
    
    if(res.success){
      document.getElementById('beepOk').play().catch(()=>{});
      
      await loadPick();
      
      // Eğer package details açıksa otomatik yenile
      if(currentlyViewedItemId) {
        showPackageDetails(currentlyViewedItemId);
      }
      
      if(res.order_completed){
        showOrderCompletedModal();
      }
    } else {
      document.getElementById('beepErr').play().catch(()=>{});
      alert(res.error || 'Hata');
    }
    
  } catch (error) {
    console.error('Verified scan error:', error);
    alert('Tarama hatası: ' + error.message);
  } finally {
    resetLocationVerification();
  }
}

// Lokasyon teyit durumunu sıfırla
function resetLocationVerification() {
  isWaitingForLocationScan = false;
  pendingPackageBarcode = null;
  
  // Input'u eski haline getir
  $('#manual').placeholder = 'Ürün Barkodunu Okutun';
  $('#manual').style.background = '';
  $('#manual').style.border = '';
  $('#last').style.color = '';
  $('#last').style.fontWeight = '';
}

// Initialize SmartBarcodeScanner for pick scanning
let pickScanner = null;

// New unlimited scan approach
let scanTimeout = null;
let currentScanInput = '';
const SCAN_TIMEOUT_MS = 4000; // 4 second timeout

function initializePickScanner() {
  console.log('🔧 Pick scanner başlatılıyor...');
  
  const barcodeInput = $('#manual');
  
  // Enhanced input handler with unlimited data entry and timeout
  barcodeInput.addEventListener('input', (e) => {
    const value = e.target.value.trim();
    currentScanInput = value;
    
    // Clear any previous timeout
    if (scanTimeout) {
      clearTimeout(scanTimeout);
      scanTimeout = null;
    }
    
    // If there's input, check for exact barcode match
    if (value.length > 0) {
      // Try to find exact match immediately
      checkForBarcodeMatch(value);
      
      // Set timeout for "barcode not found" error
      scanTimeout = setTimeout(() => {
        if (currentScanInput === value && value.length > 0) {
          // Show barcode not found error
          showBarcodeNotFoundError();
          clearScanInput();
        }
      }, SCAN_TIMEOUT_MS);
    }
  });
  
  // Keep existing manual submit functionality
  barcodeInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const value = e.target.value.trim();
      if (value.length > 0) {
        processBarcodeInput(value);
      }
    }
  });
}

// Check for exact barcode match in current pick data
async function checkForBarcodeMatch(input) {
  if (!pickData || !pickData.items) return;
  
  // Look for exact barcode match in packages
  for (const item of pickData.items) {
    if (item.packages) {
      for (const pkg of item.packages) {
        if (pkg.barcode === input) {
          // Exact match found - process immediately
          if (scanTimeout) {
            clearTimeout(scanTimeout);
            scanTimeout = null;
          }
          
          console.log(`✅ EXACT BARCODE MATCH FOUND: ${input}`);
          
          // Give immediate visual confirmation
          showBarcodeMatchConfirmation();
          
          // Process the barcode
          await processBarcodeInput(input);
          return;
        }
      }
    }
  }
  
  // Also check for shelf/location barcodes if in location verification mode
  if (isWaitingForLocationScan && pickData.items) {
    for (const item of pickData.items) {
      if (item.packages) {
        for (const pkg of item.packages) {
          if (pkg.locations) {
            for (const loc of pkg.locations) {
              if (loc.shelf_code === input) {
                // Exact location match found
                if (scanTimeout) {
                  clearTimeout(scanTimeout);
                  scanTimeout = null;
                }
                
                console.log(`✅ EXACT LOCATION MATCH FOUND: ${input}`);
                showBarcodeMatchConfirmation();
                await processBarcodeInput(input);
                return;
              }
            }
          }
        }
      }
    }
  }
}

// Process barcode input (replaces submitBarcode for new approach)
async function processBarcodeInput(code) {
  // Prevent duplicate processing
  if (isProcessingScan) {
    console.log('🚫 Processing already in progress, ignoring:', code);
    return;
  }
  
  // Clear timeout and input
  if (scanTimeout) {
    clearTimeout(scanTimeout);
    scanTimeout = null;
  }
  
  // Clear the input immediately
  clearScanInput();
  
  // Use existing submitBarcode logic
  await submitBarcode(code);
}

// Show barcode match confirmation
function showBarcodeMatchConfirmation() {
  const input = $('#manual');
  const originalBg = input.style.background;
  const originalColor = input.style.color;
  
  // Green confirmation
  input.style.background = '#22c55e';
  input.style.color = 'white';
  input.style.border = '2px solid #16a34a';
  
  // Play success beep
  document.getElementById('beepOk').play().catch(()=>{});
  
  // Reset after short delay
  setTimeout(() => {
    input.style.background = originalBg;
    input.style.color = originalColor;
    input.style.border = '';
  }, 500);
}

// Show barcode not found error
function showBarcodeNotFoundError() {
  const input = $('#manual');
  const lastSpan = $('#last');
  
  // Red error indication
  input.style.background = '#dc3545';
  input.style.color = 'white';
  input.style.border = '2px solid #b91c1c';
  
  // Show error message
  lastSpan.textContent = '❌ Barkod bulunamadı - Lütfen tekrar deneyin';
  lastSpan.style.color = '#dc3545';
  lastSpan.style.fontWeight = 'bold';
  
  // Play error beep
  document.getElementById('beepErr').play().catch(()=>{});
  
  // Reset visual state after delay
  setTimeout(() => {
    input.style.background = '';
    input.style.color = '';
    input.style.border = '';
    lastSpan.style.color = '';
    lastSpan.style.fontWeight = '';
    lastSpan.textContent = '';
  }, 2000);
}

// Clear scan input and prepare for new entry
function clearScanInput() {
  const input = $('#manual');
  input.value = '';
  currentScanInput = '';
  
  // Clear any pending timeout
  if (scanTimeout) {
    clearTimeout(scanTimeout);
    scanTimeout = null;
  }
  
  // Focus back to input for next scan
  setTimeout(() => {
    input.focus();
  }, 100);
}

$('#enter').addEventListener('click', ()=>{
  const v = $('#manual').value.trim();
  if(v) {
    // Prevent multiple button clicks
    if (isProcessingScan) {
      console.log('🚫 Manuel buton tıklaması engellendi - işlem devam ediyor');
      return;
    }
    processBarcodeInput(v);
  }
});


// Paket detaylarını göster
function showPackageDetails(itemId) {
  currentlyViewedItemId = itemId; // Hangi item'ın detayları gösterildiğini kaydet
  
  const item = pickData.items.find(it => it.id === itemId);
  if (!item || !item.packages || item.packages.length === 0) {
    $('#packageDetails').innerHTML = '<div class="no-packages">Bu ürün için paket tanımlı değil</div>';
    return;
  }

  // Taranan paketleri bul
  const scannedPackages = pickData.scans
    .filter(scan => scan.order_item_id === itemId)
    .reduce((acc, scan) => {
      acc[scan.package_id] = (acc[scan.package_id] || 0) + 1;
      return acc;
    }, {});

  const packageHtml = `
    <div class="package-section">
      <h3>📦 ${item.product_name} Paketleri</h3>
      <div class="package-grid">
        ${item.packages.map(pkg => {
          const scannedCount = scannedPackages[pkg.id] || 0;
          const requiredCount = pkg.quantity * item.quantity;
          const isComplete = scannedCount >= requiredCount;
          const progress = requiredCount > 0 ? Math.round((scannedCount / requiredCount) * 100) : 0;
          
          // Paket lokasyonlarını FIFO sırasıyla göster
          const locationsHtml = pkg.locations && pkg.locations.length > 0 
            ? `<div class="package-locations">
                 <div class="locations-header">📍 Lokasyonlar (FIFO Sırası):</div>
                 ${pkg.locations.map((loc, index) => `
                   <div class="location-item ${index === 0 ? 'first-fifo' : ''}">
                     <span class="shelf-code">${loc.shelf_code}</span>
                     <span class="shelf-info">${loc.zone}-${loc.aisle}-${loc.level}</span>
                     <span class="shelf-qty">${loc.quantity} adet</span>
                     ${index === 0 ? '<span class="fifo-badge">İlk Çıkar</span>' : ''}
                   </div>
                 `).join('')}
               </div>`
            : `<div class="no-locations">❌ Rafta stok yok</div>`;

          return `
            <div class="package-card ${isComplete ? 'completed' : (scannedCount > 0 ? 'partial' : 'pending')}">
              <div class="package-header">
                <div class="package-name">${pkg.package_number ? `Paket No: ${pkg.package_number}` : pkg.package_name}</div>
                <div class="package-status">${isComplete ? '✅' : (scannedCount > 0 ? '🔄' : '⏳')}</div>
              </div>
              <div class="package-barcode">
                <code>${pkg.barcode}</code>
              </div>
              ${pkg.package_content ? `<div class="package-content"><small>İçerik: ${pkg.package_content}</small></div>` : ''}
              ${locationsHtml}
              <div class="package-count-info">
                <div class="count-display">
                  <span class="scanned-count">${scannedCount}</span> 
                  <span class="separator">/</span> 
                  <span class="total-count">${requiredCount}</span>
                  <span class="count-label">paket</span>
                </div>
                <div class="count-status ${isComplete ? 'completed' : (scannedCount > 0 ? 'partial' : 'pending')}">
                  ${isComplete ? 'Tamamlandı' : (scannedCount > 0 ? 'Devam ediyor' : 'Bekleniyor')}
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
  
  $('#packageDetails').innerHTML = packageHtml;
}


// Global fonksiyon olarak tanımla
window.showPackageDetails = showPackageDetails;

function checkForScannedItems() {
  if (!pickData) {
    return false;
  }
  
  if (pickData.scans && pickData.scans.length > 0) {
    return true;
  }
  
  if (pickData.items && pickData.items.length > 0) {
    const scannedItems = pickData.items.filter(item => item.picked_qty > 0);
    if (scannedItems.length > 0) {
      return true;
    }
  }
  
  if (pickData.order && pickData.order.items) {
    const scannedItems = pickData.order.items.filter(item => item.picked_qty > 0);
    return scannedItems.length > 0;
  }
  
  return false;
}

function showExitModal() {
  const existingModal = document.getElementById('exitModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modal = document.createElement('div');
  modal.id = 'exitModal';
  
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    font-family: inherit;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: white;
    padding: 30px;
    border-radius: 12px;
    max-width: 500px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    text-align: center;
    color: black;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    border: 2px solid #dc3545;
  `;
  
  modalContent.innerHTML = `
    <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
    <h2 style="margin: 0 0 15px 0; color: #dc3545;">Sipariş Toplama Yarım Kaldı</h2>
    <p style="margin: 0 0 25px 0; color: #666; line-height: 1.5;">
      Bazı ürünler taratıldı ancak sipariş henüz tamamlanmadı.<br>
      Ne yapmak istiyorsunuz?
    </p>
    
    <div style="display: flex; flex-direction: column; gap: 15px;">
      <button id="cancelOrder" style="
        background: #dc3545;
        color: white;
        border: none;
        padding: 15px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.2s;
        min-height: 60px;
        touch-action: manipulation;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      ">
        🗑️ Sipariş Toplamayı İptal Et ve Kapat<br><small style="font-size: 12px; opacity: 0.8;">Tüm taramalar silinir ve rafa geri konur</small>
      </button>
      
      <button id="savePartial" style="
        background: #ffc107;
        color: #000;
        border: none;
        padding: 15px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.2s;
        min-height: 60px;
        touch-action: manipulation;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      ">
        💾 Sonra Devam Et (Kısmi Toplama Kaydet)<br><small style="font-size: 12px; opacity: 0.8;">Kaldığınız yerden devam edebilirsiniz</small>
      </button>
      
      <button id="continuePicking" style="
        background: #22c55e;
        color: white;
        border: none;
        padding: 15px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.2s;
        min-height: 60px;
        touch-action: manipulation;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      ">
        ▶️ Toplamaya Devam Et<br><small style="font-size: 12px; opacity: 0.8;">Bu sayfada kalmaya devam edin</small>
      </button>
    </div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Modal'a tıklama önle
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      // Modal dışına tıklandığında kapatma
      closeExitModal();
    }
  });
  
  // Button hover effects ve click handlers
  const cancelBtn = modal.querySelector('#cancelOrder');
  const saveBtn = modal.querySelector('#savePartial');
  const continueBtn = modal.querySelector('#continuePicking');
  
  // Hover effects
  [cancelBtn, saveBtn, continueBtn].forEach(btn => {
    if (!btn) return;
    
    btn.addEventListener('mouseenter', () => {
      btn.style.transform = 'scale(1.05)';
      if (btn.id === 'cancelOrder') btn.style.background = '#c82333';
      else if (btn.id === 'savePartial') btn.style.background = '#e0a800';
      else if (btn.id === 'continuePicking') btn.style.background = '#16a34a';
    });
    
    btn.addEventListener('mouseleave', () => {
      btn.style.transform = 'scale(1)';
      if (btn.id === 'cancelOrder') btn.style.background = '#dc3545';
      else if (btn.id === 'savePartial') btn.style.background = '#ffc107';
      else if (btn.id === 'continuePicking') btn.style.background = '#22c55e';
    });
  });
  
  // Event listeners
  if (cancelBtn) cancelBtn.addEventListener('click', handleCancelOrder);
  if (saveBtn) saveBtn.addEventListener('click', handleSavePartial);
  if (continueBtn) continueBtn.addEventListener('click', handleContinuePicking);
  
  return modal;
}

function closeExitModal() {
  const modal = document.getElementById('exitModal');
  if (modal) {
    modal.remove();
  }
}

function showOrderCompletedModal() {
  const existingModal = document.getElementById('completedModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modal = document.createElement('div');
  modal.id = 'completedModal';
  
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    font-family: inherit;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: white;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    margin: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: modalSlideIn 0.3s ease;
  `;
  
  modalContent.innerHTML = `
    <div style="font-size: 64px; margin-bottom: 20px;">🎉</div>
    <h2 style="margin: 0 0 15px 0; color: #22c55e; font-size: 24px;">Sipariş Tamamlandı!</h2>
    <p style="margin: 0 0 25px 0; color: #666; line-height: 1.5; font-size: 16px;">
      Sipariş başarıyla tamamlandı ve durumu güncellendi.
    </p>
    <div style="display: flex; gap: 15px; justify-content: center;">
      <button id="goToOrders" style="
        background: #22c55e;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.2s ease;
      ">Siparişler Sayfasına Git</button>
    </div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Button hover effect
  const button = modalContent.querySelector('#goToOrders');
  button.addEventListener('mouseenter', () => {
    button.style.background = '#16a34a';
  });
  button.addEventListener('mouseleave', () => {
    button.style.background = '#22c55e';
  });
  
  // Event listeners
  document.getElementById('goToOrders').addEventListener('click', () => {
    window.location.href = '/orders.html?refresh=true';
  });
  
  return modal;
}

async function handleCancelOrder() {
  try {
    // Sipariş toplamayı sıfırla
    const response = await fetch(`/api/picks/${pickId}/reset`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      closeExitModal();
      window.location.href = '/orders.html';
    } else {
      alert('Sipariş iptal edilirken hata oluştu. Lütfen tekrar deneyin.');
    }
  } catch (error) {
    alert('Sipariş iptal edilirken hata oluştu: ' + error.message);
  }
}

async function handleSavePartial() {
  try {
    // Kısmi toplama olarak kaydet
    const response = await fetch(`/api/picks/${pickId}/partial`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      closeExitModal();
      
      // Başarı mesajı göster
      const successDiv = document.createElement('div');
      successDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #22c55e;
        color: white;
        padding: 20px;
        border-radius: 8px;
        z-index: 10001;
        text-align: center;
        font-weight: bold;
      `;
      successDiv.innerHTML = `
        ✅ Kısmi toplama kaydedildi!<br>
        <small>Siparişler sayfasına yönlendiriliyorsunuz...</small>
      `;
      document.body.appendChild(successDiv);
      
      setTimeout(() => {
        window.location.href = '/orders.html';
      }, 2000);
      
    } else {
      alert('Kısmi toplama kaydedilirken hata oluştu. Lütfen tekrar deneyin.');
    }
  } catch (error) {
    alert('Kısmi toplama kaydedilirken hata oluştu: ' + error.message);
  }
}

function handleContinuePicking() {
  closeExitModal();
  setTimeout(() => $('#manual').focus(), 100);
}

async function handleExit() {
  const hasScannedItems = checkForScannedItems();
  
  if (!hasScannedItems) {
    window.location.href = '/orders.html';
  } else {
    try {
      const modal = showExitModal();
      
    } catch (error) {
      const confirmExit = confirm('Sipariş toplama yarım kaldı. Ne yapmak istiyorsunuz?\n\n✅ Tamam = Çıkış yap\n❌ İptal = Devam et');
      if (confirmExit) {
        try {
          const response = await fetch(`/api/picks/${pickId}/reset`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (response.ok) {
            window.location.href = '/orders.html';
          } else {
            alert('Sipariş iptal edilirken hata oluştu. Yine de çıkış yapılacak.');
            window.location.href = '/orders.html';
          }
        } catch (resetError) {
          window.location.href = '/orders.html';
        }
      }
    }
  }
}

// Sayfa kapatılırken kontrol
window.addEventListener('beforeunload', (e) => {
  if (checkForScannedItems() && !document.hidden) {
    e.preventDefault();
    e.returnValue = 'Sipariş henüz tamamlanmadı. Çıkmak istediğinizden emin misiniz?';
  }
});


// Location verification toggle functionality
function toggleLocationVerification() {
  const statusDiv = $('#locationVerifyStatus');
  const icon = $('#locationVerifyIcon');
  const text = $('#locationVerifyText');
  
  locationVerificationEnabled = !locationVerificationEnabled;
  
  if (locationVerificationEnabled) {
    // Zorunlu mod
    statusDiv.style.background = '#dc3545';
    icon.textContent = '🔒';
    text.textContent = 'Lokasyon Teyit: ZORUNLU';
  } else {
    // Opsiyonel mod
    statusDiv.style.background = '#6c757d';
    icon.textContent = '🔓';
    text.textContent = 'Lokasyon Teyit: OPSİYONEL';
  }
  
  // Input placeholder'ını da güncelle
  if (!isWaitingForLocationScan) {
    const newPlaceholder = locationVerificationEnabled 
      ? '1. Ürün Barkodunu Okutun (Lokasyon Teyit Zorunlu)'
      : 'Ürün Barkodunu Okutun';
    
    $('#manual').placeholder = newPlaceholder;
  }
  
}

// Location verification toggle button event listener
$('#locationVerifyStatus').addEventListener('click', toggleLocationVerification);


await loadPick();

// Initialize new unlimited scan approach
initializePickScanner();

// Focus on scanner input
console.log('📱 New unlimited scan approach initialized for pick mode.');

// Keep focus on scanner input
setInterval(() => {
  if (document.activeElement !== $('#manual')) {
    $('#manual').focus();
  }
}, 500);

document.addEventListener('click', (e) => {
  if (e.target !== $('#manual')) {
    setTimeout(() => $('#manual').focus(), 50);
  }
});

document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    setTimeout(() => $('#manual').focus(), 100);
  }
});

// Visual feedback for successful scan (outside setTimeout)
function showScanFeedback(success) {
  const manualInput = $('#manual');
  if (manualInput) {
    manualInput.style.background = success ? '#22c55e' : '#ef4444';
    manualInput.style.color = 'white';
    setTimeout(() => {
      manualInput.style.background = '#000';
      manualInput.style.color = '#00ff00';
    }, 300);
  }
}

// Zebra device detection and optimizations
const isZebraDevice = /Android/.test(navigator.userAgent) && 
                     (screen.width <= 900 || screen.height <= 900);

if (isZebraDevice) {
  document.body.classList.add('zebra-optimized');
  
  if ('wakeLock' in navigator) {
    navigator.wakeLock.request('screen').catch(e => {});
  }
}

// Çıkış butonu event listener
const exitBtn = document.getElementById('exitPick');

if (exitBtn) {
  // Sadece click event'i kullan, hover ile exit tetiklenmesi iptal edildi
  exitBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    handleExit();
  });
  
  exitBtn.style.pointerEvents = 'all';
  exitBtn.style.zIndex = '9999';
  
  // Hover sadece visual feedback için kullan, exit trigger etmez
  exitBtn.addEventListener('mouseenter', () => {
    exitBtn.style.backgroundColor = '#b02a37';
  });
  
  exitBtn.addEventListener('mouseleave', () => {
    exitBtn.style.backgroundColor = '#dc3545';
  });
}
</script>
</body>
</html>
