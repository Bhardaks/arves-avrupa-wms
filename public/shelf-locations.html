<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Raf LokasyonlarÄ± - WMS</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/zebra-terminal.css">
    
    <!-- Core Scripts -->
    <script src="/assets/js/auth.js"></script>
    <style>
      /* Dropdown Navigation Styles */
      .main-nav {
        display: flex;
        align-items: center;
        gap: 0;
        background: var(--header-bg, #1e293b);
      }
      
      .nav-link.standalone {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        text-decoration: none;
        color: var(--header-fg, #e2e8f0);
        transition: all 0.2s ease;
        border-right: 1px solid rgba(255,255,255,0.1);
      }
      
      .nav-link.standalone:hover {
        background: rgba(255,255,255,0.1);
        color: var(--accent, #3b82f6);
      }
      
      .nav-dropdown {
        position: relative;
        display: inline-block;
      }
      
      .nav-dropdown-trigger {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        cursor: pointer;
        color: var(--header-fg, #e2e8f0);
        transition: all 0.2s ease;
        border-right: 1px solid rgba(255,255,255,0.1);
        user-select: none;
      }
      
      .nav-dropdown-trigger:hover {
        background: rgba(255,255,255,0.1);
        color: var(--accent, #3b82f6);
      }
      
      .nav-dropdown:hover .nav-dropdown-trigger {
        background: rgba(255,255,255,0.1);
        color: var(--accent, #3b82f6);
      }
      
      .dropdown-arrow {
        margin-left: 8px;
        font-size: 10px;
        transition: transform 0.2s ease;
      }
      
      .nav-dropdown:hover .dropdown-arrow {
        transform: rotate(180deg);
      }
      
      .nav-dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 220px;
        background: var(--card, #ffffff);
        border: 1px solid var(--border, #e5e7eb);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        overflow: hidden;
      }
      
      .nav-dropdown:hover .nav-dropdown-content {
        display: block;
        animation: dropdownFadeIn 0.2s ease;
      }
      
      @keyframes dropdownFadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .nav-dropdown-link {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        text-decoration: none;
        color: var(--fg, #374151);
        transition: all 0.2s ease;
        border-bottom: 1px solid var(--border, #f3f4f6);
      }
      
      .nav-dropdown-link:last-child {
        border-bottom: none;
      }
      
      .nav-dropdown-link:hover {
        background: var(--hover, #f8fafc);
        color: var(--accent, #3b82f6);
      }
      
      .nav-icon {
        margin-right: 10px;
        font-size: 16px;
      }
      
      .nav-text {
        font-weight: 500;
        font-size: 14px;
      }
      
      /* Mobile responsive */
      @media (max-width: 768px) {
        .main-nav {
          display: none;
        }
      }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">YÃ¼kleniyor...</div>
    </div>

    <header>
      <div class="header-brand">
        <h1>WMS Netsis Entegre</h1>
        <span class="header-subtitle">Raf LokasyonlarÄ±</span>
      </div>
      <div class="header-user">
        <div class="user-info" id="userInfo" style="display: none;">
          <span class="user-name" id="userName"></span>
          <span class="user-role" id="userRole"></span>
          <button class="logout-btn" id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
      </div>
      <nav class="main-nav">
        <!-- Ana Sayfa linki -->
        <a href="/index.html" class="nav-link standalone">
          <span class="nav-icon">ğŸ </span>
          <span class="nav-text">Ana Sayfa</span>
        </a>
        
        <!-- Ana ModÃ¼ller Dropdown -->
        <div class="nav-dropdown">
          <div class="nav-dropdown-trigger">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">Ana ModÃ¼ller</span>
            <span class="dropdown-arrow">â–¼</span>
          </div>
          <div class="nav-dropdown-content">
            <a href="/products.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸ“¦</span>
              <span class="nav-text">ÃœrÃ¼nler</span>
            </a>
            <a href="/orders.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸ“‹</span>
              <span class="nav-text">SipariÅŸler</span>
            </a>
            <a href="/delivery-confirmation.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸšš</span>
              <span class="nav-text">Teslimat Ä°ÅŸlemleri</span>
            </a>
          </div>
        </div>
        
        <!-- Raf YÃ¶netimi Dropdown -->
        <div class="nav-dropdown">
          <div class="nav-dropdown-trigger">
            <span class="nav-icon">ğŸ¬</span>
            <span class="nav-text">Raf YÃ¶netimi</span>
            <span class="dropdown-arrow">â–¼</span>
          </div>
          <div class="nav-dropdown-content">
            <a href="/shelf-scanner.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸ”</span>
              <span class="nav-text">Rafa Dizim</span>
            </a>
            <a href="/shelf-locations.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸ“</span>
              <span class="nav-text">Lokasyonlar</span>
            </a>
            <a href="/shelf-admin.html" class="nav-dropdown-link">
              <span class="nav-icon">âš™ï¸</span>
              <span class="nav-text">Raf YÃ¶netimi</span>
            </a>
            <a href="/shelf-transfer.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸ”„</span>
              <span class="nav-text">Raflar ArasÄ± Transfer</span>
            </a>
            <a href="/inventory-count.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸ“Š</span>
              <span class="nav-text">Depo SayÄ±m</span>
            </a>
            <a href="/stock-management.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸ“ˆ</span>
              <span class="nav-text">Stok YÃ¶netimi</span>
            </a>
          </div>
        </div>
        
        <!-- SSH Servis Dropdown -->
        <div class="nav-dropdown">
          <div class="nav-dropdown-trigger">
            <span class="nav-icon">ğŸ”§</span>
            <span class="nav-text">SSH Servis</span>
            <span class="dropdown-arrow">â–¼</span>
          </div>
          <div class="nav-dropdown-content">
            <a href="/service-request.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸ”§</span>
              <span class="nav-text">Servis Talep</span>
            </a>
            <a href="/service-dashboard.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸ“Š</span>
              <span class="nav-text">Servis Dashboard</span>
            </a>
            <a href="/ssh-inventory.html" class="nav-dropdown-link">
              <span class="nav-icon">ğŸ“‹</span>
              <span class="nav-text">SSH Envanter</span>
            </a>
          </div>
        </div>
      </nav>
      <div id="mobileNav" class="mobile-nav">
        <button id="mobileNavToggle" class="mobile-nav-toggle">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
        <div id="mobileNavMenu" class="mobile-nav-menu">
          <div class="mobile-nav-header">
            <h3>WMS Sistemi</h3>
          </div>
          <div class="mobile-nav-group">
            <span class="mobile-nav-group-label">Ana ModÃ¼ller</span>
            <a href="/index.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸ </span>
              <span class="nav-text">Ana Sayfa</span>
            </a>
            <a href="/products.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸ“¦</span>
              <span class="nav-text">ÃœrÃ¼nler</span>
            </a>
            <a href="/orders.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸ“‹</span>
              <span class="nav-text">SipariÅŸler</span>
            </a>
            <a href="/delivery-confirmation.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸšš</span>
              <span class="nav-text">Teslimat Ä°ÅŸlemleri</span>
            </a>
          </div>
          <div class="mobile-nav-group">
            <span class="mobile-nav-group-label">Raf YÃ¶netimi</span>
            <a href="/shelf-scanner.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸ”</span>
              <span class="nav-text">Rafa Dizim</span>
            </a>
            <a href="/shelf-locations.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸ“</span>
              <span class="nav-text">Lokasyonlar</span>
            </a>
            <a href="/shelf-admin.html" class="mobile-nav-link">
              <span class="nav-icon">âš™ï¸</span>
              <span class="nav-text">Raf YÃ¶netimi</span>
            </a>
            <a href="/shelf-transfer.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸ”„</span>
              <span class="nav-text">Raflar ArasÄ± Transfer</span>
            </a>
            <a href="/inventory-count.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸ“Š</span>
              <span class="nav-text">Depo SayÄ±m</span>
            </a>
          </div>
          <div class="mobile-nav-group">
            <span class="mobile-nav-group-label">SSH Servis</span>
            <a href="/service-request.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸ”§</span>
              <span class="nav-text">Servis Talep</span>
            </a>
            <a href="/service-dashboard.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸ“Š</span>
              <span class="nav-text">Servis Dashboard</span>
            </a>
            <a href="/ssh-inventory.html" class="mobile-nav-link">
              <span class="nav-icon">ğŸ“‹</span>
              <span class="nav-text">SSH Envanter</span>
            </a>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Additional page header with refresh button -->
    <div class="page-header" style="padding: 15px; background: rgba(31,42,68,0.3); border-bottom: 1px solid var(--border); margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
            <h2 style="margin: 0; color: var(--fg);">ğŸ“ Raf Lokasyon HaritalarÄ±</h2>
            <button onclick="refreshData()" class="btn btn-outline">
                <span class="btn-icon">â†»</span>
                <span class="btn-text">Yenile</span>
            </button>
        </div>
    </div>

<main class="grid" style="max-width:1200px;margin:auto;padding:16px">

  <!-- Genel Durum -->
  <section class="card">
    <h2>ğŸ“Š Genel Durum</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalShelves">-</div>
        <div class="stat-label">Toplam Raf</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="occupiedShelves">-</div>
        <div class="stat-label">Dolu Raf</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalAssignments">-</div>
        <div class="stat-label">Toplam Atama</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalQuantity">-</div>
        <div class="stat-label">Toplam ÃœrÃ¼n</div>
      </div>
    </div>
  </section>

  <!-- Analitik Dashboard -->
  <section class="card">
    <h2>ğŸ“ˆ Analitik Dashboard</h2>
    <div class="analytics-tabs">
      <button class="tab-btn active" data-tab="optimization">ğŸ¯ Optimizasyon</button>
      <button class="tab-btn" data-tab="picking">âš¡ Picking Efficiency</button>
      <button class="tab-btn" data-tab="stock-age">â° Stok YaÅŸÄ±</button>
      <button class="tab-btn" data-tab="capacity">ğŸ“Š Kapasite</button>
    </div>
    
    <div class="analytics-content">
      <!-- Optimizasyon Tab -->
      <div class="tab-content active" id="optimization-tab">
        <div class="analytics-grid">
          <div class="analytics-card">
            <h4>ğŸ—ï¸ BoÅŸ Raflar</h4>
            <div id="emptyShelvesList" class="suggestions-list">YÃ¼kleniyor...</div>
          </div>
          <div class="analytics-card">
            <h4>âš ï¸ AÅŸÄ±rÄ± Dolu Raflar</h4>
            <div id="overcrowdedShelvesList" class="suggestions-list">YÃ¼kleniyor...</div>
          </div>
          <div class="analytics-card">
            <h4>ğŸ”€ KarÄ±ÅŸÄ±k ÃœrÃ¼n RaflarÄ±</h4>
            <div id="mixedProductsList" class="suggestions-list">YÃ¼kleniyor...</div>
          </div>
        </div>
      </div>
      
      <!-- Picking Efficiency Tab -->
      <div class="tab-content" id="picking-tab">
        <div class="analytics-grid">
          <div class="analytics-card">
            <h4>ğŸ”¥ En Ã‡ok Pick Edilen</h4>
            <div id="topPickedList" class="efficiency-list">YÃ¼kleniyor...</div>
          </div>
          <div class="analytics-card">
            <h4>ğŸ—ºï¸ Zone Picking Ä°statistikleri</h4>
            <div id="zonePickingStats" class="zone-stats">YÃ¼kleniyor...</div>
          </div>
        </div>
      </div>
      
      <!-- Stok YaÅŸÄ± Tab -->
      <div class="tab-content" id="stock-age-tab">
        <div class="analytics-grid">
          <div class="analytics-card">
            <h4>â³ Eski Stoklar (30+ gÃ¼n)</h4>
            <div id="oldStockList" class="age-list">YÃ¼kleniyor...</div>
          </div>
          <div class="analytics-card">
            <h4>ğŸš« Hareket GÃ¶rmeyen Stoklar</h4>
            <div id="stagnantStockList" class="age-list">YÃ¼kleniyor...</div>
          </div>
        </div>
      </div>
      
      <!-- Kapasite Tab -->
      <div class="tab-content" id="capacity-tab">
        <div class="analytics-grid">
          <div class="analytics-card">
            <h4>ğŸ¢ Zone Kapasite KullanÄ±mÄ±</h4>
            <div id="zoneCapacityStats" class="capacity-stats">YÃ¼kleniyor...</div>
          </div>
          <div class="analytics-card">
            <h4>ğŸ“ˆ HaftalÄ±k Trend</h4>
            <div id="weeklyTrendChart" class="trend-chart">YÃ¼kleniyor...</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Operasyonel AraÃ§lar -->
  <section class="card">
    <h2>ğŸ› ï¸ Operasyonel AraÃ§lar</h2>
    <div class="tools-grid">
      <div class="tool-card" id="transferSuggestions">
        <div class="tool-header">
          <span class="tool-icon">ğŸ”„</span>
          <h4>Transfer Ã–nerileri</h4>
        </div>
        <div class="tool-content">
          <div id="transferSuggestionsList">YÃ¼kleniyor...</div>
          <button class="tool-action-btn" onclick="generateTransferReport()">
            ğŸ“‹ Transfer Raporu OluÅŸtur
          </button>
        </div>
      </div>
      
      <div class="tool-card" id="stockAlerts">
        <div class="tool-header">
          <span class="tool-icon">ğŸš¨</span>
          <h4>Stok UyarÄ±larÄ±</h4>
        </div>
        <div class="tool-content">
          <div id="stockAlertsList">YÃ¼kleniyor...</div>
          <button class="tool-action-btn" onclick="refreshAlerts()">
            ğŸ”„ UyarÄ±larÄ± Yenile
          </button>
        </div>
      </div>
      
      <div class="tool-card" id="routeOptimizer">
        <div class="tool-header">
          <span class="tool-icon">ğŸ—ºï¸</span>
          <h4>Rota Optimizasyonu</h4>
        </div>
        <div class="tool-content">
          <input type="text" id="orderIdInput" placeholder="SipariÅŸ No girin..." class="route-input">
          <button class="tool-action-btn" onclick="analyzeRoute()">
            ğŸ¯ RotayÄ± Analiz Et
          </button>
          <div id="routeAnalysisResult"></div>
        </div>
      </div>
    </div>
  </section>


  <!-- ÃœrÃ¼n HaritasÄ± (Minimized) -->
  <section class="card">
    <div class="map-header" onclick="toggleMapSection()">
      <h2>ğŸ—ºï¸ ÃœrÃ¼n Lokasyon HaritasÄ±</h2>
      <button class="toggle-btn" id="mapToggleBtn">ğŸ“Œ GÃ¶ster</button>
    </div>
    <div class="map-container" id="mapContainer" style="display: none;">
      <div class="map-filters">
        <input type="text" id="productSearchMap" placeholder="ÃœrÃ¼n adÄ±, SKU veya barkod ara..." />
        <select id="selectedProductFilter">
          <option value="">TÃ¼m ÃœrÃ¼nler</option>
        </select>
        <button id="clearMapBtn" class="btn btn-secondary btn-sm">ğŸ”„ Temizle</button>
      </div>
      <div id="shelfMap" class="shelf-map">
        <!-- Harita burada render edilecek -->
      </div>
      <div class="map-legend">
        <div class="legend-item"><span class="legend-color empty"></span>BoÅŸ Raf</div>
        <div class="legend-item"><span class="legend-color low"></span>Az Dolu (1-33%)</div>
        <div class="legend-item"><span class="legend-color medium"></span>Orta Dolu (34-66%)</div>
        <div class="legend-item"><span class="legend-color high"></span>Dolu (67-100%)</div>
        <div class="legend-item"><span class="legend-color selected"></span>SeÃ§ili ÃœrÃ¼n</div>
      </div>
    </div>
  </section>

  <!-- ÃœrÃ¼n Hareket Takibi -->
  <section class="card">
    <h2>ğŸ“Š ÃœrÃ¼n Hareket GeÃ§miÅŸi</h2>
    <div id="movementContainer" style="display: none;">
      <div class="movement-info">
        <div class="product-info" id="selectedProductInfo">
          <!-- SeÃ§ili Ã¼rÃ¼n bilgisi -->
        </div>
        <div class="movement-chart" id="movementChart">
          <!-- Hareket grafiÄŸi -->
        </div>
      </div>
      <div class="movement-table-container">
        <table id="movementTable">
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Raf</th>
              <th>Hareket</th>
              <th>Miktar</th>
              <th>Kalan</th>
              <th>KullanÄ±cÄ±</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div id="noMovementSelected" class="empty-state">
      <div class="empty-icon">ğŸ”</div>
      <div class="empty-text">Hareket geÃ§miÅŸi gÃ¶rmek iÃ§in haritadan bir Ã¼rÃ¼n seÃ§in</div>
    </div>
  </section>

  <!-- Raf Listesi -->
  <section class="card">
    <h2>ğŸ“¦ Raf AtamalarÄ± 
      <span class="list-count">(<span id="assignmentCount">0</span> atama)</span>
    </h2>
    <div class="assignment-filters">
      <input type="text" id="assignmentSearch" placeholder="Raf kodu, Ã¼rÃ¼n adÄ±, SKU veya barkod ara..." class="search-input" />
      <button id="clearAssignmentSearch" class="btn btn-secondary btn-sm">ğŸ”„ Temizle</button>
    </div>
    <div class="assignments-container" id="assignmentsContainer">
      <!-- Kart gÃ¶rÃ¼nÃ¼mÃ¼ buraya gelecek -->
    </div>
    <div class="loading" id="loading" style="display:none">
      Veriler yÃ¼kleniyor...
    </div>
    <div class="empty-state" id="emptyState" style="display:none">
      <div class="empty-icon">ğŸ“­</div>
      <div class="empty-text">HenÃ¼z raf atamasÄ± yapÄ±lmamÄ±ÅŸ</div>
    </div>
  </section>

</main>

<!-- Raf Detay Modal -->
<div id="shelfModal" class="modal" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Raf DetaylarÄ±</h3>
      <button id="closeModal" class="close-btn">Ã—</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Raf detaylarÄ± burada gÃ¶sterilecek -->
    </div>
  </div>
</div>

<script>
let allAssignments = [];
let filteredAssignments = [];

// DOM Elements
const totalShelvesEl = document.getElementById('totalShelves');
const occupiedShelvesEl = document.getElementById('occupiedShelves');
const totalAssignmentsEl = document.getElementById('totalAssignments');
const totalQuantityEl = document.getElementById('totalQuantity');
const assignmentsContainer = document.getElementById('assignmentsContainer');
const assignmentCount = document.getElementById('assignmentCount');
const loading = document.getElementById('loading');
const emptyState = document.getElementById('emptyState');
const assignmentSearch = document.getElementById('assignmentSearch');
const clearAssignmentSearch = document.getElementById('clearAssignmentSearch');

// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', async () => {
  // Mobile nav
  const toggle = document.getElementById('mobileNavToggle');
  const menu = document.getElementById('mobileNavMenu');
  toggle?.addEventListener('click', () => {
    menu.classList.toggle('active');
  });
  
  await loadData();
  setupEventListeners();
});

// Veri yÃ¼kleme
async function loadData() {
  try {
    loading.style.display = 'block';
    
    // Raf atamalarÄ± ve genel istatistikler paralel yÃ¼kle
    const [assignmentsResponse, shelvesResponse] = await Promise.all([
      fetch('/api/shelf-assignments'),
      fetch('/api/shelves')
    ]);
    
    if (!assignmentsResponse.ok || !shelvesResponse.ok) {
      throw new Error('Veri yÃ¼klenemedi');
    }
    
    const assignmentsData = await assignmentsResponse.json();
    const shelvesData = await shelvesResponse.json();
    
    allAssignments = assignmentsData.assignments || [];
    filteredAssignments = [...allAssignments];
    
    updateStatistics(shelvesData.shelves || [], allAssignments);
    displayAssignments(filteredAssignments);
    
  } catch (error) {
    console.error('Veri yÃ¼kleme hatasÄ±:', error);
    showError('Veriler yÃ¼klenirken hata oluÅŸtu');
  } finally {
    loading.style.display = 'none';
  }
}

// Ä°statistikleri gÃ¼ncelle
function updateStatistics(shelves, assignments) {
  const occupiedShelfIds = new Set(assignments.map(a => a.shelf_id));
  const totalQty = assignments.reduce((sum, a) => sum + (a.quantity || 0), 0);
  
  totalShelvesEl.textContent = shelves.length;
  occupiedShelvesEl.textContent = occupiedShelfIds.size;
  totalAssignmentsEl.textContent = assignments.length;
  totalQuantityEl.textContent = totalQty;
}


// Event listeners
function setupEventListeners() {
  // Modal
  document.getElementById('closeModal').addEventListener('click', () => {
    document.getElementById('shelfModal').style.display = 'none';
  });
  
  // Assignment search
  assignmentSearch.addEventListener('input', debounce((e) => {
    filterAssignments(e.target.value);
  }, 300));
  
  // Clear search
  clearAssignmentSearch.addEventListener('click', () => {
    assignmentSearch.value = '';
    filterAssignments('');
  });
}


// AtamalarÄ± gÃ¶rÃ¼ntÃ¼le
function displayAssignments(assignments) {
  assignmentCount.textContent = assignments.length;
  
  const container = document.getElementById('assignmentsContainer');
  
  if (assignments.length === 0) {
    container.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  container.innerHTML = assignments.map(assignment => `
    <div class="assignment-card">
      <div class="card-header">
        <div class="shelf-info">
          <div class="shelf-code">${assignment.shelf_code}</div>
          <div class="shelf-name">${assignment.shelf_name}</div>
          <div class="zone-location">
            <span class="zone-badge zone-${assignment.zone}">${assignment.zone}</span>
            <span class="location-info">Koridor ${assignment.aisle}</span>
            <span class="location-info">Seviye ${assignment.level}</span>
          </div>
        </div>
      </div>
      
      <div class="card-body">
        <div class="product-section">
          <div class="product-name">${assignment.product_name}</div>
          <div class="product-sku">SKU: ${assignment.sku}</div>
        </div>
        
        <div class="package-section">
          <div class="package-number">${assignment.package_number || '-'}</div>
          <div class="package-content">Ä°Ã§erik: ${assignment.package_content || assignment.package_name || '-'}</div>
        </div>
        
        <div class="barcode-section">
          <div class="barcode-display">${assignment.barcode}</div>
        </div>
      </div>
      
      <div class="card-footer">
        <div class="quantity-display">
          <span class="quantity-value">${assignment.quantity} adet</span>
        </div>
        <div class="date-info">${assignment.assigned_date_formatted}</div>
      </div>
      
      <div class="card-actions">
        <button onclick="showShelfDetails(${assignment.shelf_id})" class="btn-sm btn-info">
          ğŸ‘ï¸ Detay
        </button>
        <button onclick="removeAssignment('${assignment.shelf_code}', '${assignment.barcode}')" class="btn-sm btn-warning">
          â– Ã‡Ä±kar
        </button>
      </div>
    </div>
  `).join('');
}

// Raf detaylarÄ±nÄ± gÃ¶ster
async function showShelfDetails(shelfId) {
  try {
    const response = await fetch(`/api/shelves/${shelfId}`);
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error);
    }
    
    const { shelf, packages } = data;
    
    document.getElementById('modalTitle').textContent = `${shelf.shelf_code} - ${shelf.shelf_name}`;
    document.getElementById('modalBody').innerHTML = `
      <div class="shelf-details">
        <div class="detail-section">
          <h4>ğŸ“ Raf Bilgileri</h4>
          <div class="detail-grid">
            <div><strong>BÃ¶lge:</strong> ${shelf.zone}</div>
            <div><strong>Koridor:</strong> ${shelf.aisle}</div>
            <div><strong>Seviye:</strong> ${shelf.level}</div>
            <div><strong>Kapasite:</strong> ${shelf.capacity}</div>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>ğŸ“¦ Bu Raftaki Paketler (${packages.length})</h4>
          ${packages.length === 0 ? '<p>Bu rafta hiÃ§ paket yok.</p>' : `
            <div class="packages-list">
              ${packages.map(pkg => `
                <div class="package-item">
                  <div class="package-info">
                    <strong>${pkg.product_name}</strong><br>
                    <small>${pkg.package_name} â€¢ ${pkg.barcode}</small>
                  </div>
                  <div class="package-quantity">${pkg.quantity} adet</div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
        
        <div class="detail-actions">
          <button onclick="window.location.href='/shelf-scanner.html'" class="btn-primary">
            ğŸ“± Bu Rafa ÃœrÃ¼n Ekle
          </button>
          <button onclick="viewShelfMovements(${shelfId})" class="btn-info">
            ğŸ“‹ Hareket GeÃ§miÅŸi
          </button>
        </div>
      </div>
    `;
    
    document.getElementById('shelfModal').style.display = 'block';
    
  } catch (error) {
    console.error('Raf detaylarÄ± yÃ¼klenemedi:', error);
    showError('Raf detaylarÄ± yÃ¼klenemedi');
  }
}

// AtamayÄ± kaldÄ±r
async function removeAssignment(shelfCode, barcode) {
  if (!confirm('Bu atamayÄ± kaldÄ±rmak istediÄŸinizden emin misiniz?')) {
    return;
  }
  
  try {
    const response = await fetch('/api/shelves/remove', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        shelf_code: shelfCode,
        package_barcode: barcode,
        quantity: 999, // TÃ¼mÃ¼nÃ¼ kaldÄ±r
        removed_by: 'Admin'
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error);
    }
    
    showSuccess(data.message);
    await loadData(); // Verileri yenile
    
  } catch (error) {
    console.error('Atama kaldÄ±rma hatasÄ±:', error);
    showError('Atama kaldÄ±rÄ±lamadÄ±: ' + error.message);
  }
}


// Assignment filtreleme
function filterAssignments(searchTerm) {
  if (!searchTerm.trim()) {
    filteredAssignments = [...allAssignments];
  } else {
    const term = searchTerm.toLowerCase();
    filteredAssignments = allAssignments.filter(assignment => 
      assignment.shelf_code?.toLowerCase().includes(term) ||
      assignment.shelf_name?.toLowerCase().includes(term) ||
      assignment.product_name?.toLowerCase().includes(term) ||
      assignment.sku?.toLowerCase().includes(term) ||
      assignment.package_name?.toLowerCase().includes(term) ||
      assignment.package_number?.toLowerCase().includes(term) ||
      assignment.package_content?.toLowerCase().includes(term) ||
      assignment.barcode?.toLowerCase().includes(term)
    );
  }
  
  displayAssignments(filteredAssignments);
}

// YardÄ±mcÄ± fonksiyonlar
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function showError(message) {
  // Basit error gÃ¶sterimi - daha geliÅŸmiÅŸ toast sistemi eklenebilir
  alert('Hata: ' + message);
}

function showSuccess(message) {
  // Basit success gÃ¶sterimi - daha geliÅŸmiÅŸ toast sistemi eklenebilir
  alert('BaÅŸarÄ±lÄ±: ' + message);
}

// Verileri yenile
async function refreshData() {
  try {
    console.log('ğŸ”„ Veriler yenileniyor...');
    
    // Loading gÃ¶ster
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // TÃ¼m veriyi yeniden yÃ¼kle
    await Promise.all([
      loadData(),        // Raf atamalarÄ± iÃ§in
      loadMapData(),     // Harita iÃ§in 
      loadAnalyticsData('optimization'), // Analitik tab
      loadTransferSuggestions()
    ]);
    
    console.log('âœ… Veriler baÅŸarÄ±yla yenilendi');
    showSuccess('Veriler yenilendi');
  } catch (error) {
    console.error('âŒ Veri yenileme hatasÄ±:', error);
    showError('Veriler yenilenirken hata oluÅŸtu');
  } finally {
    // Loading gizle
    document.getElementById('loadingOverlay').style.display = 'none';
  }
}

// ============== ÃœRÃœN HARÄ°TASI VE HAREKET TAKÄ°BÄ° ===============

let allShelves = [];
let selectedProduct = null;
let tooltip = null;

// Harita verilerini yÃ¼kle
async function loadMapData() {
  try {
    console.log('ğŸ”„ Harita verileri yÃ¼kleniyor...');
    
    // TÃ¼m raflarÄ± al
    const shelvesResponse = await fetch('/api/shelves');
    const shelvesData = await shelvesResponse.json();
    allShelves = shelvesData.shelves || [];
    console.log(`ğŸ“š YÃ¼klenen raf sayÄ±sÄ±: ${allShelves.length}`);
    
    // Raf atamalarÄ±nÄ± al
    const assignmentsResponse = await fetch('/api/shelf-assignments');
    const assignmentsData = await assignmentsResponse.json();
    const assignments = assignmentsData.assignments || [];
    console.log(`ğŸ“¦ YÃ¼klenen assignment sayÄ±sÄ±: ${assignments.length}`);
    
    // RaflarÄ± atama bilgileriyle zenginleÅŸtir
    enrichShelvesWithAssignments(assignments);
    
    // HaritayÄ± render et
    renderShelfMap();
    
    // ÃœrÃ¼n filtresini doldur
    populateProductFilter(assignments);
    
  } catch (error) {
    console.error('Harita verileri yÃ¼klenirken hata:', error);
    showError('Harita verileri yÃ¼klenemedi');
  }
}

// RaflarÄ± atama bilgileriyle zenginleÅŸtir
function enrichShelvesWithAssignments(assignments) {
  console.log(`ğŸ” enrichShelvesWithAssignments Ã§alÄ±ÅŸÄ±yor. Assignment sayÄ±sÄ±: ${assignments.length}`);
  
  if (assignments.length > 0) {
    console.log('ğŸ“‹ Ä°lk assignment:', assignments[0]);
  }
  
  const shelfAssignments = {};
  
  assignments.forEach(assignment => {
    if (!shelfAssignments[assignment.shelf_id]) {
      shelfAssignments[assignment.shelf_id] = {
        products: [],
        totalQuantity: 0,
        assignments: []
      };
    }
    
    shelfAssignments[assignment.shelf_id].products.push({
      name: assignment.product_name,
      sku: assignment.sku,
      packageName: assignment.package_name,
      barcode: assignment.barcode,
      quantity: assignment.quantity,
      productId: assignment.product_id || assignment.id // Fallback iÃ§in id de kullan
    });
    
    shelfAssignments[assignment.shelf_id].totalQuantity += assignment.quantity || 0;
    shelfAssignments[assignment.shelf_id].assignments.push(assignment);
  });
  
  // RaflarÄ± gÃ¼ncelle
  allShelves.forEach(shelf => {
    const assignment = shelfAssignments[shelf.id];
    shelf.products = assignment ? assignment.products : [];
    shelf.totalQuantity = assignment ? assignment.totalQuantity : 0;
    shelf.assignments = assignment ? assignment.assignments : [];
    shelf.capacity = shelf.capacity || 100;
    shelf.occupancyRate = shelf.capacity > 0 ? (shelf.totalQuantity / shelf.capacity) * 100 : 0;
  });
}

// ÃœrÃ¼n filtresi doldur
function populateProductFilter(assignments) {
  const productFilter = document.getElementById('selectedProductFilter');
  const uniqueProducts = [];
  const seenProducts = new Set();
  
  assignments.forEach(assignment => {
    const key = `${assignment.product_id}-${assignment.sku}`;
    if (!seenProducts.has(key)) {
      seenProducts.add(key);
      uniqueProducts.push({
        id: assignment.product_id,
        name: assignment.product_name,
        sku: assignment.sku
      });
    }
  });
  
  uniqueProducts.sort((a, b) => a.name.localeCompare(b.name));
  
  productFilter.innerHTML = '<option value="">TÃ¼m ÃœrÃ¼nler</option>' + 
    uniqueProducts.map(product => 
      `<option value="${product.id}">${product.name} (${product.sku})</option>`
    ).join('');
}

// Raf haritasÄ±nÄ± render et
function renderShelfMap() {
  const mapContainer = document.getElementById('shelfMap');
  
  console.log(`ğŸ—ºï¸ Harita render ediliyor... Toplam ${allShelves.length} raf`);
  
  // RaflarÄ±n Ã¼rÃ¼n durumunu kontrol et
  let shelvesWithProducts = allShelves.filter(shelf => shelf.products && shelf.products.length > 0);
  console.log(`ğŸ“¦ ÃœrÃ¼n iÃ§eren raf sayÄ±sÄ±: ${shelvesWithProducts.length}`);
  
  if (shelvesWithProducts.length > 0) {
    console.log('ğŸ“‹ Ä°lk birkaÃ§ Ã¼rÃ¼nlÃ¼ raf:');
    shelvesWithProducts.slice(0, 3).forEach(shelf => {
      console.log(`  - ${shelf.shelf_code}: ${shelf.products.length} Ã¼rÃ¼n, Toplam: ${shelf.totalQuantity}`);
    });
  }
  
  // BÃ¶lgelere gÃ¶re grupla
  const zoneGroups = {};
  allShelves.forEach(shelf => {
    if (!zoneGroups[shelf.zone]) {
      zoneGroups[shelf.zone] = {};
    }
    if (!zoneGroups[shelf.zone][shelf.aisle]) {
      zoneGroups[shelf.zone][shelf.aisle] = [];
    }
    zoneGroups[shelf.zone][shelf.aisle].push(shelf);
  });
  
  // Her bÃ¶lge iÃ§in container oluÅŸtur
  mapContainer.innerHTML = Object.keys(zoneGroups).sort().map(zone => {
    const aisles = zoneGroups[zone];
    
    return `
      <div class="zone-section">
        <div class="zone-title">${zone} BÃ¶lgesi</div>
        <div class="aisles-container">
          ${Object.keys(aisles).sort((a, b) => parseInt(a) - parseInt(b)).map(aisle => {
            const shelves = aisles[aisle].sort((a, b) => a.level - b.level);
            
            return `
              <div class="aisle-row">
                <div class="aisle-label">Koridor ${aisle}</div>
                <div class="shelves-row">
                  ${shelves.map(shelf => renderShelfCell(shelf)).join('')}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }).join('');
  
  // Event listener'larÄ± ekle
  setupShelfClickHandlers();
}

// Raf hÃ¼cresini render et
function renderShelfCell(shelf) {
  let statusClass = 'empty';
  
  if (shelf.occupancyRate > 66) statusClass = 'high';
  else if (shelf.occupancyRate > 33) statusClass = 'medium';
  else if (shelf.occupancyRate > 0) statusClass = 'low';
  
  // SeÃ§ili Ã¼rÃ¼n vurgulamasÄ±
  if (selectedProduct && shelf.products.some(p => p.productId == selectedProduct)) {
    statusClass = 'selected';
  }
  
  const productNames = shelf.products.map(p => p.name).join(', ');
  const shortProductName = productNames.length > 20 ? productNames.substring(0, 17) + '...' : productNames;
  
  return `
    <div class="shelf-cell ${statusClass}" 
         data-shelf-id="${shelf.id}"
         data-shelf-code="${shelf.shelf_code}"
         onmouseenter="showShelfTooltip(event, ${shelf.id})"
         onmouseleave="hideShelfTooltip()">
      <div class="shelf-code">${shelf.shelf_code}</div>
      <div class="shelf-products">${shortProductName}</div>
      <div class="shelf-quantity">${shelf.totalQuantity}</div>
    </div>
  `;
}

// Raf tÄ±klama event handler'larÄ±
function setupShelfClickHandlers() {
  document.querySelectorAll('.shelf-cell').forEach(cell => {
    cell.addEventListener('click', (e) => {
      const shelfId = parseInt(e.currentTarget.dataset.shelfId);
      const shelf = allShelves.find(s => s.id === shelfId);
      
      if (shelf && shelf.products.length > 0) {
        // Ä°lk Ã¼rÃ¼nÃ¼ seÃ§ (birden fazla Ã¼rÃ¼n varsa kullanÄ±cÄ± seÃ§ebilir)
        showProductMovements(shelf.products[0].productId, shelf.products[0].name);
      } else {
        showError('Bu rafta Ã¼rÃ¼n bulunmuyor');
      }
    });
  });
}

// Tooltip gÃ¶ster
function showShelfTooltip(event, shelfId) {
  const shelf = allShelves.find(s => s.id === shelfId);
  if (!shelf) return;
  
  hideShelfTooltip();
  
  tooltip = document.createElement('div');
  tooltip.className = 'shelf-tooltip';
  tooltip.innerHTML = `
    <strong>${shelf.shelf_code}</strong><br>
    ${shelf.shelf_name}<br>
    Kapasite: ${shelf.totalQuantity}/${shelf.capacity}<br>
    ÃœrÃ¼n SayÄ±sÄ±: ${shelf.products.length}<br>
    ${shelf.products.map(p => `â€¢ ${p.name} (${p.quantity})`).join('<br>')}
  `;
  
  document.body.appendChild(tooltip);
  
  // Pozisyonu ayarla
  const rect = event.target.getBoundingClientRect();
  tooltip.style.left = (rect.left + rect.width / 2) + 'px';
  tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
}

// Tooltip gizle
function hideShelfTooltip() {
  if (tooltip) {
    document.body.removeChild(tooltip);
    tooltip = null;
  }
}

// ÃœrÃ¼n hareketlerini gÃ¶ster
async function showProductMovements(productId, productName) {
  selectedProduct = productId;
  
  try {
    // Hareket verilerini al
    const response = await fetch(`/api/products/${productId}/movements`);
    let movements = [];
    
    if (response.ok) {
      const data = await response.json();
      movements = data.movements || [];
    }
    
    // UI'Ä± gÃ¼ncelle
    document.getElementById('selectedProductInfo').innerHTML = `
      <div class="product-name">${productName}</div>
      <div class="product-details">
        SKU: ${movements[0]?.sku || 'N/A'}<br>
        Toplam Hareket: ${movements.length}<br>
        Son Hareket: ${movements[0]?.created_at || 'HenÃ¼z hareket yok'}
      </div>
    `;
    
    // Hareket tablosunu doldur
    const tbody = document.getElementById('movementTable').querySelector('tbody');
    tbody.innerHTML = movements.map(movement => `
      <tr>
        <td>${new Date(movement.created_at).toLocaleDateString('tr-TR')}</td>
        <td>${movement.shelf_code || 'N/A'}</td>
        <td>${movement.movement_type || 'GiriÅŸ'}</td>
        <td>${movement.quantity || 0}</td>
        <td>${movement.remaining_quantity || 0}</td>
        <td>${movement.user_name || 'Sistem'}</td>
      </tr>
    `).join('') || '<tr><td colspan="6">HenÃ¼z hareket kaydÄ± yok</td></tr>';
    
    // Basit grafik gÃ¶ster
    renderMovementChart(movements);
    
    // Container'larÄ± gÃ¶ster/gizle
    document.getElementById('movementContainer').style.display = 'block';
    document.getElementById('noMovementSelected').style.display = 'none';
    
    // HaritayÄ± gÃ¼ncelle (seÃ§ili Ã¼rÃ¼nÃ¼ vurgula)
    renderShelfMap();
    
  } catch (error) {
    console.error('ÃœrÃ¼n hareketleri yÃ¼klenirken hata:', error);
    showError('ÃœrÃ¼n hareketleri yÃ¼klenemedi');
  }
}

// Basit hareket grafiÄŸi render et
function renderMovementChart(movements) {
  const chartContainer = document.getElementById('movementChart');
  
  if (movements.length === 0) {
    chartContainer.innerHTML = '<div style="text-align: center; color: #666;">HenÃ¼z hareket verisi yok</div>';
    return;
  }
  
  // Son 7 gÃ¼nÃ¼n verilerini gÃ¶ster
  const last7Days = movements.slice(0, 7);
  const maxQuantity = Math.max(...last7Days.map(m => m.quantity || 0));
  
  chartContainer.innerHTML = `
    <div style="display: flex; align-items: end; gap: 5px; height: 80px;">
      ${last7Days.reverse().map((movement, index) => {
        const height = maxQuantity > 0 ? ((movement.quantity || 0) / maxQuantity) * 60 : 5;
        return `
          <div style="
            width: 20px; 
            height: ${height}px; 
            background: linear-gradient(135deg, #4c4cff, #7c7cff);
            border-radius: 2px;
            position: relative;
            margin-bottom: 10px;
          " title="${new Date(movement.created_at).toLocaleDateString('tr-TR')}: ${movement.quantity}">
            <div style="
              position: absolute;
              bottom: -15px;
              font-size: 8px;
              transform: rotate(-45deg);
              transform-origin: top left;
            ">${new Date(movement.created_at).getDate()}</div>
          </div>
        `;
      }).join('')}
    </div>
    <div style="text-align: center; font-size: 12px; color: #666; margin-top: 10px;">
      Son ${last7Days.length} Hareket
    </div>
  `;
}

// Harita filtrelerini ayarla
function setupMapFilters() {
  const productSearchMap = document.getElementById('productSearchMap');
  const selectedProductFilter = document.getElementById('selectedProductFilter');
  const clearMapBtn = document.getElementById('clearMapBtn');
  
  // ÃœrÃ¼n arama
  productSearchMap.addEventListener('input', debounce((e) => {
    const searchTerm = e.target.value.toLowerCase();
    
    if (searchTerm.length >= 2) {
      // Arama terimi ile eÅŸleÅŸen Ã¼rÃ¼nleri bul
      const matchingProducts = [];
      allShelves.forEach(shelf => {
        shelf.products.forEach(product => {
          if (product.name.toLowerCase().includes(searchTerm) ||
              product.sku.toLowerCase().includes(searchTerm) ||
              product.barcode.toLowerCase().includes(searchTerm)) {
            matchingProducts.push(product.productId);
          }
        });
      });
      
      if (matchingProducts.length > 0) {
        selectedProduct = matchingProducts[0];
        renderShelfMap();
      }
    } else if (searchTerm.length === 0) {
      selectedProduct = null;
      renderShelfMap();
    }
  }, 300));
  
  // ÃœrÃ¼n filtresi
  selectedProductFilter.addEventListener('change', (e) => {
    const productId = e.target.value;
    if (productId) {
      selectedProduct = parseInt(productId);
      const productName = e.target.options[e.target.selectedIndex].text.split(' (')[0];
      showProductMovements(productId, productName);
    } else {
      selectedProduct = null;
      renderShelfMap();
      document.getElementById('movementContainer').style.display = 'none';
      document.getElementById('noMovementSelected').style.display = 'block';
    }
  });
  
  // Temizle butonu
  clearMapBtn.addEventListener('click', () => {
    selectedProduct = null;
    productSearchMap.value = '';
    selectedProductFilter.value = '';
    renderShelfMap();
    document.getElementById('movementContainer').style.display = 'none';
    document.getElementById('noMovementSelected').style.display = 'block';
  });
}

// ============== ANALÄ°TÄ°K DASHBOARD FONKSÄ°YONLARI ==============

// Tab sistemi
function setupAnalyticsTabs() {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tabName = e.target.dataset.tab;
      switchAnalyticsTab(tabName);
    });
  });
}

function switchAnalyticsTab(tabName) {
  // Tab butonlarÄ±nÄ± gÃ¼ncelle
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  
  // Tab iÃ§eriklerini gÃ¼ncelle
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(`${tabName}-tab`).classList.add('active');
  
  // Tab verilerini yÃ¼kle
  loadAnalyticsData(tabName);
}

// Analitik verilerini yÃ¼kle
async function loadAnalyticsData(tabName) {
  try {
    switch(tabName) {
      case 'optimization':
        await loadOptimizationData();
        break;
      case 'picking':
        await loadPickingData();
        break;
      case 'stock-age':
        await loadStockAgeData();
        break;
      case 'capacity':
        await loadCapacityData();
        break;
    }
  } catch (error) {
    console.error(`${tabName} verisi yÃ¼klenirken hata:`, error);
  }
}

// Optimizasyon verilerini yÃ¼kle
async function loadOptimizationData() {
  try {
    const response = await fetch('/api/analytics/optimization');
    const data = await response.json();
    
    // BoÅŸ raflar
    document.getElementById('emptyShelvesList').innerHTML = 
      data.empty_shelves.length === 0 ? '<div class="no-data">TÃ¼m raflar kullanÄ±mda</div>' :
      data.empty_shelves.map(shelf => `
        <div class="suggestion-item">
          <div class="suggestion-info">
            <strong>${shelf.shelf_code}</strong> - ${shelf.shelf_name}
            <span class="suggestion-detail">${shelf.zone} BÃ¶lgesi, Koridor ${shelf.aisle}, Seviye ${shelf.level}</span>
          </div>
          <button class="action-btn-sm" onclick="assignToShelf('${shelf.shelf_code}')">ğŸ“¦ Atama Yap</button>
        </div>
      `).join('');
    
    // AÅŸÄ±rÄ± dolu raflar
    document.getElementById('overcrowdedShelvesList').innerHTML = 
      data.overcrowded_shelves.length === 0 ? '<div class="no-data">AÅŸÄ±rÄ± dolu raf yok</div>' :
      data.overcrowded_shelves.map(shelf => `
        <div class="suggestion-item warning">
          <div class="suggestion-info">
            <strong>${shelf.shelf_code}</strong> - ${shelf.total_quantity}/${shelf.capacity}
            <span class="suggestion-detail">${shelf.suggestion}</span>
          </div>
          <button class="action-btn-sm" onclick="redistributeShelf('${shelf.shelf_code}')">ğŸ”„ DaÄŸÄ±t</button>
        </div>
      `).join('');
    
    // KarÄ±ÅŸÄ±k Ã¼rÃ¼n raflarÄ±
    document.getElementById('mixedProductsList').innerHTML = 
      data.mixed_product_shelves.length === 0 ? '<div class="no-data">Tek Ã¼rÃ¼n politikasÄ± uygulanÄ±yor</div>' :
      data.mixed_product_shelves.map(shelf => `
        <div class="suggestion-item info">
          <div class="suggestion-info">
            <strong>${shelf.shelf_code}</strong> - ${shelf.product_count} farklÄ± Ã¼rÃ¼n
            <span class="suggestion-detail">${shelf.suggestion}</span>
          </div>
          <button class="action-btn-sm" onclick="consolidateProducts('${shelf.shelf_code}')">ğŸ¯ Konsolide Et</button>
        </div>
      `).join('');
      
  } catch (error) {
    console.error('Optimizasyon verileri yÃ¼klenirken hata:', error);
  }
}

// Picking verilerini yÃ¼kle
async function loadPickingData() {
  try {
    const response = await fetch('/api/analytics/picking');
    const data = await response.json();
    
    // En Ã§ok pick edilen Ã¼rÃ¼nler
    document.getElementById('topPickedList').innerHTML = 
      data.top_picked_products.length === 0 ? '<div class="no-data">HenÃ¼z picking verisi yok</div>' :
      data.top_picked_products.map(item => `
        <div class="efficiency-item">
          <div class="product-info">
            <strong>${item.name}</strong>
            <span class="product-detail">${item.sku} â€¢ ${item.zone || 'N/A'}-${item.aisle || 'N/A'}-${item.level || 'N/A'}</span>
          </div>
          <div class="pick-count">${item.pick_count} pick</div>
        </div>
      `).join('');
    
    // Zone istatistikleri
    document.getElementById('zonePickingStats').innerHTML = 
      data.zone_stats.length === 0 ? '<div class="no-data">Zone verisi yok</div>' :
      data.zone_stats.map(zone => `
        <div class="zone-stat-item">
          <div class="zone-header">
            <span class="zone-badge zone-${zone.zone}">${zone.zone} BÃ¶lgesi</span>
            <span class="zone-picks">${zone.total_picks} pick</span>
          </div>
          <div class="zone-details">
            ${zone.unique_products} farklÄ± Ã¼rÃ¼n â€¢ Ort. seviye ${parseFloat(zone.avg_level).toFixed(1)}
          </div>
        </div>
      `).join('');
      
  } catch (error) {
    console.error('Picking verileri yÃ¼klenirken hata:', error);
  }
}

// Stok yaÅŸÄ± verilerini yÃ¼kle
async function loadStockAgeData() {
  try {
    const response = await fetch('/api/analytics/stock-age');
    const data = await response.json();
    
    // Eski stoklar
    document.getElementById('oldStockList').innerHTML = 
      data.old_stock.length === 0 ? '<div class="no-data">30+ gÃ¼nlÃ¼k eski stok yok</div>' :
      data.old_stock.map(item => `
        <div class="age-item old">
          <div class="age-info">
            <strong>${item.name}</strong>
            <span class="age-detail">${item.shelf_code} â€¢ ${Math.round(item.days_old)} gÃ¼n eski</span>
          </div>
          <div class="age-quantity">${item.quantity} adet</div>
        </div>
      `).join('');
    
    // Durgun stoklar
    document.getElementById('stagnantStockList').innerHTML = 
      data.stagnant_stock.length === 0 ? '<div class="no-data">TÃ¼m stoklar aktif</div>' :
      data.stagnant_stock.map(item => `
        <div class="age-item stagnant">
          <div class="age-info">
            <strong>${item.name}</strong>
            <span class="age-detail">${item.shelf_code} â€¢ ${Math.round(item.days_stagnant)} gÃ¼n hareketsiz</span>
          </div>
          <div class="age-quantity">${item.quantity} adet</div>
        </div>
      `).join('');
      
  } catch (error) {
    console.error('Stok yaÅŸÄ± verileri yÃ¼klenirken hata:', error);
  }
}

// Kapasite verilerini yÃ¼kle
async function loadCapacityData() {
  try {
    const response = await fetch('/api/analytics/capacity');
    const data = await response.json();
    
    // Zone kapasite kullanÄ±mÄ±
    document.getElementById('zoneCapacityStats').innerHTML = 
      data.zone_capacity.length === 0 ? '<div class="no-data">Kapasite verisi yok</div>' :
      data.zone_capacity.map(zone => `
        <div class="capacity-item">
          <div class="capacity-header">
            <span class="zone-badge zone-${zone.zone}">${zone.zone} BÃ¶lgesi</span>
            <span class="utilization-rate">${zone.utilization_rate}%</span>
          </div>
          <div class="capacity-bar">
            <div class="capacity-fill" style="width: ${Math.min(zone.utilization_rate, 100)}%"></div>
          </div>
          <div class="capacity-details">
            ${zone.current_stock}/${zone.total_capacity} â€¢ ${zone.occupied_shelves}/${zone.total_shelves} raf
          </div>
        </div>
      `).join('');
    
    // HaftalÄ±k trend basit chart
    document.getElementById('weeklyTrendChart').innerHTML = 
      data.weekly_trend.length === 0 ? '<div class="no-data">Trend verisi yok</div>' :
      `<div class="trend-bars">
        ${data.weekly_trend.reverse().map(day => `
          <div class="trend-bar" title="${day.date}: ${day.net_change > 0 ? '+' : ''}${day.net_change}">
            <div class="trend-date">${new Date(day.date).getDate()}</div>
            <div class="trend-value ${day.net_change >= 0 ? 'positive' : 'negative'}" 
                 style="height: ${Math.abs(day.net_change) * 3 + 10}px;">
              ${day.net_change > 0 ? '+' : ''}${day.net_change}
            </div>
          </div>
        `).join('')}
      </div>`;
      
  } catch (error) {
    console.error('Kapasite verileri yÃ¼klenirken hata:', error);
  }
}

// ============== OPERASYONEL ARAÃ‡LAR FONKSÄ°YONLARI ==============

// Transfer Ã¶nerilerini yÃ¼kle
async function loadTransferSuggestions() {
  try {
    const response = await fetch('/api/analytics/transfer-suggestions');
    const data = await response.json();
    
    const combinedSuggestions = [
      ...data.unbalanced_products.map(item => ({...item, type: 'unbalanced'})),
      ...data.critical_stock.map(item => ({...item, type: 'critical'}))
    ];
    
    document.getElementById('transferSuggestionsList').innerHTML = 
      combinedSuggestions.length === 0 ? '<div class="no-data">Transfer Ã¶nerisi yok</div>' :
      combinedSuggestions.slice(0, 8).map(item => `
        <div class="transfer-item ${item.type}">
          <div class="transfer-info">
            <strong>${item.name}</strong>
            <span class="transfer-detail">${item.sku} â€¢ ${item.recommendation}</span>
          </div>
          <div class="transfer-actions">
            ${item.type === 'critical' ? 
              `<span class="critical-badge">${item.quantity} adet</span>` :
              `<span class="zone-count">${item.zone_count} zone</span>`
            }
          </div>
        </div>
      `).join('');
      
  } catch (error) {
    console.error('Transfer Ã¶nerileri yÃ¼klenirken hata:', error);
  }
}

// Operasyonel fonksiyonlar
function generateTransferReport() {
  alert('ğŸ“‹ Transfer raporu oluÅŸturma Ã¶zelliÄŸi yakÄ±nda eklenecek');
}

function refreshAlerts() {
  loadTransferSuggestions();
  showSuccess('ğŸ”„ UyarÄ±lar yenilendi');
}

async function analyzeRoute() {
  const orderId = document.getElementById('orderIdInput').value.trim();
  if (!orderId) {
    alert('LÃ¼tfen sipariÅŸ numarasÄ± girin');
    return;
  }
  
  try {
    const response = await fetch(`/api/analytics/picking-route/${orderId}`);
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error);
    }
    
    document.getElementById('routeAnalysisResult').innerHTML = `
      <div class="route-result">
        <div class="route-summary">
          <strong>Rota Analizi</strong>
          <div class="efficiency-gain">%${data.efficiency_gain} verimlilik artÄ±ÅŸÄ±</div>
        </div>
        <div class="route-details">
          <div>Mevcut Mesafe: ${data.current_distance}</div>
          <div>Optimal Mesafe: ${data.optimized_distance}</div>
          <div>Toplam Item: ${data.current_route.length}</div>
        </div>
      </div>
    `;
    
  } catch (error) {
    document.getElementById('routeAnalysisResult').innerHTML = 
      `<div class="route-error">âŒ ${error.message}</div>`;
  }
}

// Raf iÅŸlem fonksiyonlarÄ±
function assignToShelf(shelfCode) {
  window.location.href = `/shelf-scanner.html?shelf=${shelfCode}`;
}

function redistributeShelf(shelfCode) {
  window.location.href = `/shelf-transfer.html?from=${shelfCode}`;
}

function consolidateProducts(shelfCode) {
  alert(`ğŸ¯ ${shelfCode} rafÄ± iÃ§in Ã¼rÃ¼n konsolidasyonu yakÄ±nda eklenecek`);
}

// Sayfa yÃ¼klendiÄŸinde harita sistemini baÅŸlat
document.addEventListener('DOMContentLoaded', async function() {
  try {
    // Event listener'larÄ± kur
    setupEventListeners();
    setupMapFilters();
    setupAnalyticsTabs();
    
    // TÃ¼m veriyi paralel yÃ¼kle (harita hariÃ§)
    await Promise.all([
      loadData(),        // Raf atamalarÄ± iÃ§in
      // loadMapData(),     // Harita lazy load edilecek
      loadAnalyticsData('optimization'), // Ä°lk analitik tab
      loadTransferSuggestions()
    ]);
    
    console.log('âœ… TÃ¼m veriler yÃ¼klendi');
  } catch (error) {
    console.error('âŒ Sayfa yÃ¼klenirken hata:', error);
  }
});

// Harita bÃ¶lÃ¼mÃ¼nÃ¼ toggle et
function toggleMapSection() {
  const container = document.getElementById('mapContainer');
  const toggleBtn = document.getElementById('mapToggleBtn');
  
  if (container.style.display === 'none') {
    container.style.display = 'block';
    toggleBtn.textContent = 'ğŸ“ Gizle';
    // Ä°lk kez aÃ§Ä±lÄ±yorsa harita verilerini yÃ¼kle
    if (!allShelves.length) {
      loadMapData();
    }
  } else {
    container.style.display = 'none';
    toggleBtn.textContent = 'ğŸ“Œ GÃ¶ster';
  }
}

</script>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
}

.stat-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.stat-number {
  font-size: 2.5em;
  font-weight: bold;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.9em;
  opacity: 0.9;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px;
  align-items: center;
}

.quick-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
}

.zone-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
}

.zone-A { background: #e3f2fd; color: #1976d2; }
.zone-B { background: #f3e5f5; color: #7b1fa2; }
.zone-C { background: #e8f5e8; color: #388e3c; }

.quantity-badge {
  background: #ff9800;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-weight: bold;
}

.action-buttons {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
}

.btn-sm {
  padding: 4px 8px;
  font-size: 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-sm.btn-info {
  background: #2196f3;
  color: white;
}

.btn-sm.btn-warning {
  background: #ff9800;
  color: white;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: var(--card);
  color: var(--fg);
  border-radius: 12px;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  margin: 20px;
  border: 1px solid var(--border);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid var(--border);
}

.modal-header h3 {
  margin: 0;
  color: var(--accent);
  font-weight: 600;
}

.close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--muted);
  transition: color 0.2s ease;
}

.close-btn:hover {
  color: var(--fg);
}

.modal-body {
  padding: 20px;
}

.detail-section {
  margin-bottom: 20px;
}

.detail-section h4 {
  margin: 0 0 10px 0;
  color: var(--accent);
  font-weight: 600;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  color: var(--fg);
}

.detail-grid div {
  padding: 8px;
  background: rgba(31,42,68,0.2);
  border-radius: 6px;
}

.detail-grid strong {
  color: var(--accent);
}

.packages-list {
  max-height: 200px;
  overflow-y: auto;
}

.package-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid var(--border);
  background: rgba(31,42,68,0.1);
  margin-bottom: 4px;
  border-radius: 6px;
}

.package-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.package-info {
  color: var(--fg);
}

.package-info strong {
  color: var(--accent);
  font-weight: 600;
}

.package-info small {
  color: var(--muted);
}

.package-quantity {
  font-weight: bold;
  color: var(--success);
  background: rgba(34,197,94,0.1);
  padding: 4px 8px;
  border-radius: 4px;
}

.detail-actions {
  margin-top: 20px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

.empty-icon {
  font-size: 48px;
  margin-bottom: 10px;
}

.empty-text {
  color: var(--muted);
  font-size: 14px;
}

.loading {
  text-align: center;
  padding: 40px;
  color: var(--muted);
}

.assignment-filters {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  align-items: center;
}

.search-input {
  flex: 1;
  padding: 10px 15px;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--fg);
  font-size: 14px;
}

.search-input:focus {
  border-color: var(--accent);
  outline: none;
  box-shadow: 0 0 8px rgba(59, 130, 246, 0.2);
}

.search-input::placeholder {
  color: var(--muted);
}

/* Map Section Styling */
.map-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  padding: 10px 0;
}

.toggle-btn {
  background: var(--accent);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.toggle-btn:hover {
  background: var(--accent-hover);
  transform: translateY(-2px);
}

.map-container {
  margin-top: 15px;
  border-top: 2px solid var(--border);
  padding-top: 20px;
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .filters-grid {
    grid-template-columns: 1fr;
  }
  
  .quick-actions {
    grid-template-columns: 1fr;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .detail-actions {
    flex-direction: column;
  }
  
  .map-header h2 {
    font-size: 1.4em;
  }
  
  .toggle-btn {
    padding: 6px 12px;
    font-size: 12px;
  }
}

/* Kart GÃ¶rÃ¼nÃ¼mÃ¼ Stilleri */
.assignments-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.assignment-card {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 16px;
  transition: all 0.2s ease;
  position: relative;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.assignment-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.shelf-info {
  flex: 1;
}

.shelf-code {
  font-size: 1.2em;
  font-weight: bold;
  color: #2c3e50;
  margin-bottom: 4px;
}

.shelf-name {
  color: #6c757d;
  font-size: 0.9em;
}

.zone-location {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
}

.location-info {
  background: #f8f9fa;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.85em;
  color: #495057;
}

.card-body {
  border-top: 1px solid #e9ecef;
  padding-top: 12px;
}

.product-section {
  margin-bottom: 12px;
}

.product-name {
  font-weight: 600;
  color: #2c3e50;
  margin-bottom: 4px;
}

.product-sku {
  color: #6c757d;
  font-size: 0.9em;
}

.package-section {
  margin-bottom: 12px;
}

.package-number {
  font-weight: 600;
  color: #495057;
  margin-bottom: 4px;
}

.package-content {
  color: #6c757d;
  font-size: 0.9em;
}

.barcode-section {
  margin-bottom: 12px;
}

.barcode-display {
  font-family: 'Courier New', monospace;
  background: #f8f9fa;
  padding: 6px 8px;
  border-radius: 4px;
  font-size: 0.9em;
  color: #495057;
  border: 1px solid #dee2e6;
}

.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #e9ecef;
}

.quantity-display {
  display: flex;
  align-items: center;
  gap: 8px;
}

.quantity-value {
  background: linear-gradient(135deg, #007bff, #0056b3);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 0.9em;
}

.date-info {
  color: #6c757d;
  font-size: 0.85em;
}

.card-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.card-actions .btn-sm {
  padding: 4px 8px;
  font-size: 0.8em;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-info {
  background: #17a2b8;
  color: white;
}

.btn-info:hover {
  background: #138496;
}

.btn-warning {
  background: #ffc107;
  color: #212529;
}

.btn-warning:hover {
  background: #e0a800;
}

/* Mobil uyumluluk iÃ§in kart gÃ¶rÃ¼nÃ¼mÃ¼ */
@media (max-width: 768px) {
  .assignments-container {
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .assignment-card {
    padding: 12px;
  }

  .card-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .zone-location {
    flex-wrap: wrap;
  }

  .card-actions {
    justify-content: center;
    flex-wrap: wrap;
  }
}
</style>

<script>
// Mobile navigation toggle
document.getElementById('mobileNavToggle').addEventListener('click', () => {
  const menu = document.getElementById('mobileNavMenu');
  menu.classList.toggle('show');
});

// Close mobile menu when clicking outside
document.addEventListener('click', (e) => {
  const nav = document.getElementById('mobileNav');
  const menu = document.getElementById('mobileNavMenu');
  if (!nav.contains(e.target)) {
    menu.classList.remove('show');
  }
});
</script>

</body>
</html>