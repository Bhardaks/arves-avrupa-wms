<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>SSH Servis Dashboard</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
  <script src="/assets/js/auth-new.js"></script>
  <style>
    /* Dropdown Navigation Styles */
    .main-nav {
      display: flex;
      align-items: center;
      gap: 0;
      background: var(--header-bg, #1e293b);
    }
    
    .nav-link.standalone {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      text-decoration: none;
      color: var(--header-fg, #e2e8f0);
      transition: all 0.2s ease;
      border-right: 1px solid rgba(255,255,255,0.1);
    }
    
    .nav-link.standalone:hover {
      background: rgba(255,255,255,0.1);
      color: var(--accent, #3b82f6);
    }
    
    .nav-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .nav-dropdown-trigger {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      cursor: pointer;
      color: var(--header-fg, #e2e8f0);
      transition: all 0.2s ease;
      border-right: 1px solid rgba(255,255,255,0.1);
      user-select: none;
    }
    
    .nav-dropdown-trigger:hover {
      background: rgba(255,255,255,0.1);
      color: var(--accent, #3b82f6);
    }
    
    .nav-dropdown:hover .nav-dropdown-trigger {
      background: rgba(255,255,255,0.1);
      color: var(--accent, #3b82f6);
    }
    
    .dropdown-arrow {
      margin-left: 8px;
      font-size: 10px;
      transition: transform 0.2s ease;
    }
    
    .nav-dropdown:hover .dropdown-arrow {
      transform: rotate(180deg);
    }
    
    .nav-dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      min-width: 220px;
      background: var(--card, #ffffff);
      border: 1px solid var(--border, #e5e7eb);
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow: hidden;
    }
    
    .nav-dropdown:hover .nav-dropdown-content {
      display: block;
      animation: dropdownFadeIn 0.2s ease;
    }
    
    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .nav-dropdown-link {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      text-decoration: none;
      color: var(--fg, #374151);
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--border, #f3f4f6);
    }
    
    .nav-dropdown-link:last-child {
      border-bottom: none;
    }
    
    .nav-dropdown-link:hover {
      background: var(--hover, #f8fafc);
      color: var(--accent, #3b82f6);
    }
    
    .nav-icon {
      margin-right: 10px;
      font-size: 16px;
    }
    
    .nav-text {
      font-weight: 500;
      font-size: 14px;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .main-nav {
        display: none;
      }
    }
  </style>
  <style>
    /* Global mobile overflow fix */
    html, body {
      max-width: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    
    *, *:before, *:after {
      box-sizing: border-box;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1rem;
    }
    .tab-btn {
      background: none;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
      color: var(--muted);
    }
    .tab-btn:hover {
      background-color: var(--hover);
      color: var(--fg);
    }
    .tab-btn.active {
      border-bottom-color: var(--accent);
      color: var(--accent);
    }
    .table-container {
      overflow-x: auto;
    }
    
    /* Stats cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .stat-card {
      background: var(--card);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
      border-left: 4px solid;
    }
    
    .stat-card.urgent { border-left-color: var(--danger); }
    .stat-card.pending { border-left-color: var(--warning); }
    .stat-card.in-progress { border-left-color: var(--accent); }
    .stat-card.completed { border-left-color: var(--success); }
    
    .stat-icon { font-size: 2rem; }
    .stat-content h3 { margin: 0; font-size: 2rem; color: var(--fg); }
    .stat-content p { margin: 0; color: var(--muted); font-size: 0.9rem; }
    
    /* Priority and status badges */
    .priority-badge, .status-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      text-align: center;
      display: inline-block;
      min-width: 70px;
    }
    
    .priority-urgent { background: var(--danger); color: white; }
    .priority-high { background: #f97316; color: white; }
    .priority-normal { background: var(--muted); color: white; }
    .priority-low { background: var(--success); color: white; }
    
    .status-new { background: var(--muted); color: white; }
    .status-pending { background: var(--warning); color: var(--bg); }
    .status-sourcing { background: var(--accent); color: white; }
    .status-package_opening { background: #8b5cf6; color: white; }
    .status-ssh_storage { background: #ec4899; color: white; }
    .status-factory_order { background: #f97316; color: white; }
    .status-completed { background: var(--success); color: white; }
    .status-cancelled { background: var(--danger); color: white; }
    
    /* Mobile cards */
    .mobile-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .mobile-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    
    .mobile-card-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .mobile-card-title {
      font-weight: 600;
      color: var(--fg);
    }
    
    .mobile-card-content {
      padding: 1rem;
    }
    
    .mobile-card-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .mobile-card-row:last-child {
      margin-bottom: 0;
    }
    
    .mobile-label {
      font-weight: 500;
      color: var(--muted);
    }
    
    .mobile-card-actions {
      padding: 1rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
    }
    
    /* Modal styling */
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .detail-section {
      background: var(--bg);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .detail-section.full-width {
      grid-column: 1 / -1;
    }
    
    .detail-section h4 {
      margin: 0 0 1rem 0;
      color: var(--accent);
      font-size: 1.1rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.5rem;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      padding: 0.5rem 0;
    }
    
    .detail-row:last-child {
      margin-bottom: 0;
    }
    
    .detail-label {
      font-weight: 500;
      color: var(--muted);
      min-width: 120px;
    }
    
    .detail-value {
      color: var(--fg);
      text-align: right;
      flex: 1;
    }
    
    .issue-description {
      background: var(--card);
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid var(--accent);
      line-height: 1.6;
      color: var(--fg);
    }
    
    .required-part {
      color: var(--accent);
      font-weight: 600;
    }
    
    .package-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .package-info small {
      color: var(--muted);
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
    
    .package-badge {
      background: var(--accent);
      color: white;
      padding: 0.2rem 0.4rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-block;
      margin-top: 0.25rem;
    }
    
    /* Desktop/Mobile responsive display */
    .desktop-table { display: block; }
    .mobile-cards { display: none; }
    
    @media (max-width: 768px) {
      .desktop-table { display: none; }
      .mobile-cards { display: block; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      
      .detail-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .detail-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }
      
      .detail-value {
        text-align: left;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="header-brand">
    <h1>WMS Netsis Entegre</h1>
    <span class="header-subtitle">SSH Servis Dashboard</span>
  </div>
  <div class="header-user">
    <div class="user-info" id="userInfo" style="display: none;">
      <span class="user-name" id="userName"></span>
      <span class="user-role" id="userRole"></span>
      <button class="logout-btn" id="logoutBtn">√áƒ±kƒ±≈ü</button>
    </div>
  </div>
  <nav class="main-nav">
    <!-- Ana Sayfa linki -->
    <a href="/index.html" class="nav-link standalone">
      <span class="nav-icon">üè†</span>
      <span class="nav-text">Ana Sayfa</span>
    </a>
    
    <!-- Ana Mod√ºller Dropdown -->
    <div class="nav-dropdown">
      <div class="nav-dropdown-trigger">
        <span class="nav-icon">üìä</span>
        <span class="nav-text">Ana Mod√ºller</span>
        <span class="dropdown-arrow">‚ñº</span>
      </div>
      <div class="nav-dropdown-content">
        <a href="/products.html" class="nav-dropdown-link">
          <span class="nav-icon">üì¶</span>
          <span class="nav-text">√úr√ºnler</span>
        </a>
        <a href="/orders.html" class="nav-dropdown-link">
          <span class="nav-icon">üìã</span>
          <span class="nav-text">Sipari≈üler</span>
        </a>
        <a href="/delivery-confirmation.html" class="nav-dropdown-link">
          <span class="nav-icon">üöö</span>
          <span class="nav-text">Teslimat ƒ∞≈ülemleri</span>
        </a>
      </div>
    </div>
    
    <!-- Raf Y√∂netimi Dropdown -->
    <div class="nav-dropdown">
      <div class="nav-dropdown-trigger">
        <span class="nav-icon">üè¨</span>
        <span class="nav-text">Raf Y√∂netimi</span>
        <span class="dropdown-arrow">‚ñº</span>
      </div>
      <div class="nav-dropdown-content">
        <a href="/shelf-scanner.html" class="nav-dropdown-link">
          <span class="nav-icon">üîç</span>
          <span class="nav-text">Rafa Dizim</span>
        </a>
        <a href="/shelf-locations.html" class="nav-dropdown-link">
          <span class="nav-icon">üìç</span>
          <span class="nav-text">Lokasyonlar</span>
        </a>
        <a href="/shelf-admin.html" class="nav-dropdown-link">
          <span class="nav-icon">‚öôÔ∏è</span>
          <span class="nav-text">Raf Y√∂netimi</span>
        </a>
        <a href="/shelf-transfer.html" class="nav-dropdown-link">
          <span class="nav-icon">üîÑ</span>
          <span class="nav-text">Raflar Arasƒ± Transfer</span>
        </a>
        <a href="/inventory-count.html" class="nav-dropdown-link">
          <span class="nav-icon">üìä</span>
          <span class="nav-text">Depo Sayƒ±m</span>
        </a>
        <a href="/stock-management.html" class="nav-dropdown-link">
          <span class="nav-icon">üìà</span>
          <span class="nav-text">Stok Y√∂netimi</span>
        </a>
      </div>
    </div>
    
    <!-- SSH Servis Dropdown -->
    <div class="nav-dropdown">
      <div class="nav-dropdown-trigger">
        <span class="nav-icon">üîß</span>
        <span class="nav-text">SSH Servis</span>
        <span class="dropdown-arrow">‚ñº</span>
      </div>
      <div class="nav-dropdown-content">
        <a href="/service-request.html" class="nav-dropdown-link">
          <span class="nav-icon">üîß</span>
          <span class="nav-text">Servis Talep</span>
        </a>
        <a href="/service-dashboard.html" class="nav-dropdown-link">
          <span class="nav-icon">üìä</span>
          <span class="nav-text">Servis Dashboard</span>
        </a>
        <a href="/ssh-inventory.html" class="nav-dropdown-link">
          <span class="nav-icon">üìã</span>
          <span class="nav-text">SSH Envanter</span>
        </a>
      </div>
    </div>
  </nav>
  <div id="mobileNav" class="mobile-nav">
    <button id="mobileNavToggle" class="mobile-nav-toggle">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    <div id="mobileNavMenu" class="mobile-nav-menu">
      <div class="mobile-nav-header">
        <h3>WMS Sistemi</h3>
      </div>
      <div class="mobile-nav-group">
        <span class="mobile-nav-group-label">Ana Mod√ºller</span>
        <a href="/index.html" class="mobile-nav-link">
          <span class="nav-icon">üè†</span>
          <span class="nav-text">Ana Sayfa</span>
        </a>
        <a href="/products.html" class="mobile-nav-link">
          <span class="nav-icon">üì¶</span>
          <span class="nav-text">√úr√ºnler</span>
        </a>
        <a href="/orders.html" class="mobile-nav-link">
          <span class="nav-icon">üìã</span>
          <span class="nav-text">Sipari≈üler</span>
        </a>
        <a href="/delivery-confirmation.html" class="mobile-nav-link">
          <span class="nav-icon">üöö</span>
          <span class="nav-text">Teslimat ƒ∞≈ülemleri</span>
        </a>
      </div>
      <div class="mobile-nav-group">
        <span class="mobile-nav-group-label">Raf Y√∂netimi</span>
        <a href="/shelf-scanner.html" class="mobile-nav-link">
          <span class="nav-icon">üîç</span>
          <span class="nav-text">Rafa Dizim</span>
        </a>
        <a href="/shelf-locations.html" class="mobile-nav-link">
          <span class="nav-icon">üìç</span>
          <span class="nav-text">Lokasyonlar</span>
        </a>
        <a href="/shelf-admin.html" class="mobile-nav-link">
          <span class="nav-icon">‚öôÔ∏è</span>
          <span class="nav-text">Raf Y√∂netimi</span>
        </a>
        <a href="/shelf-transfer.html" class="mobile-nav-link">
          <span class="nav-icon">üîÑ</span>
          <span class="nav-text">Raflar Arasƒ± Transfer</span>
        </a>
        <a href="/inventory-count.html" class="mobile-nav-link">
          <span class="nav-icon">üìä</span>
          <span class="nav-text">Depo Sayƒ±m</span>
        </a>
      </div>
      <div class="mobile-nav-group">
        <span class="mobile-nav-group-label">SSH Servis</span>
        <a href="/service-request.html" class="mobile-nav-link">
          <span class="nav-icon">üîß</span>
          <span class="nav-text">Servis Talep</span>
        </a>
        <a href="/service-dashboard.html" class="mobile-nav-link">
          <span class="nav-icon">üìä</span>
          <span class="nav-text">Servis Dashboard</span>
        </a>
        <a href="/ssh-inventory.html" class="mobile-nav-link">
          <span class="nav-icon">üìã</span>
          <span class="nav-text">SSH Envanter</span>
        </a>
      </div>
    </div>
  </div>
</header>

<main class="main-content">
  <div class="content-header">
    <h2>üîß SSH Servis Dashboard</h2>
    <p>Aktif servis talepleri ve durum takibi</p>
  </div>

  <!-- Tabs for filtering -->
  <div class="tabs">
    <button class="tab-btn active" onclick="filterByStatus('')">T√ºm√º</button>
    <button class="tab-btn" onclick="filterByStatus('new')">Yeni</button>
    <button class="tab-btn" onclick="filterByStatus('pending')">Beklemede</button>
    <button class="tab-btn" onclick="filterByStatus('sourcing')">Par√ßa Temin</button>
    <button class="tab-btn" onclick="filterByStatus('completed')">Tamamlandƒ±</button>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card urgent">
      <div class="stat-icon">üö®</div>
      <div class="stat-content">
        <h3 id="urgentCount">0</h3>
        <p>Acil Talepler</p>
      </div>
    </div>
    <div class="stat-card pending">
      <div class="stat-icon">‚è≥</div>
      <div class="stat-content">
        <h3 id="pendingCount">0</h3>
        <p>Beklemede</p>
      </div>
    </div>
    <div class="stat-card in-progress">
      <div class="stat-icon">üîÑ</div>
      <div class="stat-content">
        <h3 id="inProgressCount">0</h3>
        <p>ƒ∞≈ülemde</p>
      </div>
    </div>
    <div class="stat-card completed">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-content">
        <h3 id="completedCount">0</h3>
        <p>Tamamlandƒ±</p>
      </div>
    </div>
  </div>

  <!-- Service Requests Table - Desktop -->
  <div class="table-container desktop-table">
    <table id="requestsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>M√º≈üteri</th>
          <th>√úr√ºn</th>
          <th>Sorun</th>
          <th>√ñncelik</th>
          <th>Durum</th>
          <th>Tarih</th>
          <th>ƒ∞≈ülemler</th>
        </tr>
      </thead>
      <tbody id="requestsTableBody">
        <!-- Dynamic content will be loaded here -->
      </tbody>
    </table>
  </div>

  <!-- Service Requests Cards - Mobile -->
  <div class="mobile-cards" id="mobileRequestCards">
    <!-- Dynamic mobile cards will be loaded here -->
  </div>

  <!-- Loading indicator -->
  <div id="loadingIndicator" class="loading-indicator" style="display: none;">
    <div class="loading-spinner"></div>
    <p>Servis talepleri y√ºkleniyor...</p>
  </div>

  <!-- Empty state -->
  <div id="emptyState" class="empty-state" style="display: none;">
    <div class="empty-icon">üìã</div>
    <h3>Hen√ºz servis talebi yok</h3>
    <p>ƒ∞lk servis talebini olu≈üturmak i√ßin "Servis Talep" sayfasƒ±nƒ± kullanƒ±n.</p>
    <a href="/service-request.html" class="action-btn primary">Yeni Servis Talebi</a>
  </div>
</main>

<!-- Service Request Detail Modal -->
<div id="serviceModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Servis Talebi Detaylarƒ±</h3>
      <button class="modal-close" onclick="closeServiceModal()">&times;</button>
    </div>
    <div class="modal-body" id="serviceModalBody">
      <!-- Dynamic content -->
    </div>
    <div class="modal-footer">
      <button class="action-btn secondary" onclick="closeServiceModal()">Kapat</button>
      <button class="action-btn primary" onclick="showStatusUpdate()">Durum G√ºncelle</button>
      <button class="action-btn success" onclick="openPackageStation()" id="packageOpeningBtn" style="display: none;">üìÇ Paket A√ßma</button>
    </div>
  </div>
</div>

<!-- Status Update Modal -->
<div id="statusModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Servis Durumu G√ºncelle</h3>
      <button class="modal-close" onclick="closeStatusModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="statusUpdateForm">
        <div class="form-group">
          <label for="newStatus">Yeni Durum:</label>
          <select id="newStatus" required>
            <option value="">Se√ßiniz</option>
            <option value="new">Yeni</option>
            <option value="pending">Beklemede</option>
            <option value="sourcing">Par√ßa Temin</option>
            <option value="package_opening">Paket A√ßma</option>
            <option value="ssh_storage">SSH Depolama</option>
            <option value="factory_order">Fabrika Sipari≈ü</option>
            <option value="completed">Tamamlandƒ±</option>
            <option value="cancelled">ƒ∞ptal</option>
          </select>
        </div>
        <div class="form-group">
          <label for="statusNote">Durum Notu:</label>
          <textarea id="statusNote" rows="3" placeholder="ƒ∞steƒüe baƒülƒ± not..."></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="action-btn secondary" onclick="closeStatusModal()">ƒ∞ptal</button>
      <button class="action-btn primary" onclick="updateServiceStatus()">G√ºncelle</button>
    </div>
  </div>
</div>

<script>
let allRequests = [];
let filteredRequests = [];
let currentRequest = null;
let currentStatusFilter = '';

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß SSH Servis Dashboard y√ºklendi');
    loadServiceRequests();
    
    // Auto-refresh every 30 seconds
    setInterval(loadServiceRequests, 30000);
});


// Load service requests from API
async function loadServiceRequests() {
    try {
        document.getElementById('loadingIndicator').style.display = 'block';
        
        const response = await fetch('/api/service-requests');
        const data = await response.json();
        
        if (data.success) {
            allRequests = data.requests;
            filterByStatus(currentStatusFilter);
            updateStatistics();
        } else {
            throw new Error(data.error || 'Servis talepleri y√ºklenemedi');
        }
    } catch (error) {
        console.error('‚ùå Servis talepleri y√ºkleme hatasƒ±:', error);
        showError('Servis talepleri y√ºklenirken hata olu≈ütu: ' + error.message);
    } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

// Update statistics cards
function updateStatistics() {
    const stats = {
        urgent: allRequests.filter(r => r.priority === 'urgent').length,
        pending: allRequests.filter(r => r.status === 'new' || r.status === 'pending').length,
        inProgress: allRequests.filter(r => ['sourcing', 'package_opening', 'ssh_storage', 'factory_order'].includes(r.status)).length,
        completed: allRequests.filter(r => r.status === 'completed').length
    };
    
    document.getElementById('urgentCount').textContent = stats.urgent;
    document.getElementById('pendingCount').textContent = stats.pending;
    document.getElementById('inProgressCount').textContent = stats.inProgress;
    document.getElementById('completedCount').textContent = stats.completed;
}

// Filter by status (tab-based)
function filterByStatus(status) {
    currentStatusFilter = status;
    
    // Update active tab
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event?.target?.classList.add('active');
    
    // Filter requests
    filteredRequests = status ? allRequests.filter(r => r.status === status) : [...allRequests];
    displayRequests();
}

// Display filtered requests in table and mobile cards
function displayRequests() {
    const tbody = document.getElementById('requestsTableBody');
    const mobileCards = document.getElementById('mobileRequestCards');
    const emptyState = document.getElementById('emptyState');
    
    if (filteredRequests.length === 0) {
        tbody.innerHTML = '';
        mobileCards.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // Desktop table
    tbody.innerHTML = filteredRequests.map(request => `
        <tr onclick="showRequestDetail(${request.id})" style="cursor: pointer;">
            <td><strong>#${request.id}</strong></td>
            <td>
                <strong>${request.customer_name}</strong>
                ${request.customer_phone ? `<br><small>${request.customer_phone}</small>` : ''}
            </td>
            <td>
                <strong>${request.product_name}</strong>
                <br><small>${request.product_sku}</small>
                ${request.package_number ? `<br><span class="package-badge">üì¶ ${request.package_number}</span>` : ''}
            </td>
            <td>${truncateText(request.issue_description, 30)}</td>
            <td>
                <span class="priority-badge priority-${request.priority}">
                    ${getPriorityText(request.priority)}
                </span>
            </td>
            <td>
                <span class="status-badge status-${request.status}">
                    ${getStatusText(request.status)}
                </span>
            </td>
            <td>${formatDate(request.created_at)}</td>
            <td>
                ${request.status === 'completed' ? 
                    '<span style="color: var(--success); font-weight: 600;">‚úÖ Tamamlandƒ±</span>' :
                    `<button class="action-btn primary small" onclick="event.stopPropagation(); startProcessing(${request.id})">
                        ƒ∞≈üleme Ba≈üla
                    </button>`
                }
            </td>
        </tr>
    `).join('');
    
    // Mobile cards
    mobileCards.innerHTML = filteredRequests.map(request => `
        <div class="mobile-card" onclick="showRequestDetail(${request.id})">
            <div class="mobile-card-header">
                <div class="mobile-card-title">
                    <strong>#${request.id}</strong> - ${request.customer_name}
                </div>
                <span class="status-badge status-${request.status}">
                    ${getStatusText(request.status)}
                </span>
            </div>
            <div class="mobile-card-content">
                <div class="mobile-card-row">
                    <span class="mobile-label">√úr√ºn:</span>
                    <span>${request.product_name}</span>
                </div>
                <div class="mobile-card-row">
                    <span class="mobile-label">SKU:</span>
                    <span>${request.product_sku}</span>
                </div>
                ${request.package_number ? `
                    <div class="mobile-card-row">
                        <span class="mobile-label">Paket No:</span>
                        <span class="package-badge">${request.package_number}</span>
                    </div>
                ` : ''}
                <div class="mobile-card-row">
                    <span class="mobile-label">Sorun:</span>
                    <span>${truncateText(request.issue_description, 40)}</span>
                </div>
                <div class="mobile-card-row">
                    <span class="mobile-label">√ñncelik:</span>
                    <span class="priority-badge priority-${request.priority}">
                        ${getPriorityText(request.priority)}
                    </span>
                </div>
                <div class="mobile-card-row">
                    <span class="mobile-label">Tarih:</span>
                    <span>${formatDate(request.created_at)}</span>
                </div>
            </div>
            <div class="mobile-card-actions">
                ${request.status === 'completed' ? 
                    '<span style="color: var(--success); font-weight: 600;">‚úÖ Tamamlandƒ±</span>' :
                    `<button class="action-btn primary small" onclick="event.stopPropagation(); startProcessing(${request.id})">
                        ƒ∞≈üleme Ba≈üla
                    </button>
                    ${request.status !== 'cancelled' ? `
                        <button class="action-btn secondary small" onclick="event.stopPropagation(); quickStatusUpdate(${request.id})">
                            G√ºncelle
                        </button>
                    ` : ''}`
                }
            </div>
        </div>
    `).join('');
}

// Show request detail modal
async function showRequestDetail(requestId) {
    currentRequest = allRequests.find(r => r.id === requestId);
    if (!currentRequest) return;
    
    const modalBody = document.getElementById('serviceModalBody');
    modalBody.innerHTML = `
        <div class="detail-grid">
            <div class="detail-section">
                <h4>üìã Talep Bilgileri</h4>
                <div class="detail-row">
                    <span class="detail-label">Talep ID:</span>
                    <span class="detail-value"><strong>#${currentRequest.id}</strong></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Durum:</span>
                    <span class="status-badge status-${currentRequest.status}">
                        ${getStatusText(currentRequest.status)}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">√ñncelik:</span>
                    <span class="priority-badge priority-${currentRequest.priority}">
                        ${getPriorityText(currentRequest.priority)}
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Olu≈üturma Tarihi:</span>
                    <span class="detail-value">${formatDateTime(currentRequest.created_at)}</span>
                </div>
            </div>
            
            <div class="detail-section">
                <h4>üë§ M√º≈üteri Bilgileri</h4>
                <div class="detail-row">
                    <span class="detail-label">M√º≈üteri Adƒ±:</span>
                    <span class="detail-value"><strong>${currentRequest.customer_name}</strong></span>
                </div>
                ${currentRequest.customer_phone ? `
                    <div class="detail-row">
                        <span class="detail-label">Telefon:</span>
                        <span class="detail-value">${currentRequest.customer_phone}</span>
                    </div>
                ` : ''}
                ${currentRequest.customer_email ? `
                    <div class="detail-row">
                        <span class="detail-label">E-mail:</span>
                        <span class="detail-value">${currentRequest.customer_email}</span>
                    </div>
                ` : ''}
                ${currentRequest.order_number ? `
                    <div class="detail-row">
                        <span class="detail-label">Sipari≈ü No:</span>
                        <span class="detail-value">${currentRequest.order_number}</span>
                    </div>
                ` : ''}
            </div>
            
            <div class="detail-section">
                <h4>üì¶ √úr√ºn Bilgileri</h4>
                <div class="detail-row">
                    <span class="detail-label">√úr√ºn Adƒ±:</span>
                    <span class="detail-value"><strong>${currentRequest.product_name}</strong></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">SKU:</span>
                    <span class="detail-value">${currentRequest.product_sku}</span>
                </div>
                ${currentRequest.package_number ? `
                    <div class="detail-row">
                        <span class="detail-label">Paket No:</span>
                        <span class="detail-value package-info">
                            <strong>${currentRequest.package_number}</strong>
                            <small>(ƒ∞√ßerik: ${currentRequest.package_name}, Barkod: ${currentRequest.package_barcode})</small>
                        </span>
                    </div>
                ` : ''}
                <div class="detail-row">
                    <span class="detail-label">Gerekli Par√ßa:</span>
                    <span class="detail-value required-part">${currentRequest.required_part || '-'}</span>
                </div>
            </div>
            
            <div class="detail-section full-width">
                <h4>üîß Sorun Detaylarƒ±</h4>
                <div class="issue-description">
                    ${currentRequest.issue_description}
                </div>
            </div>
        </div>
    `;
    
    // Show package opening button if status allows
    const packageBtn = document.getElementById('packageOpeningBtn');
    if (currentRequest.status === 'sourcing' || currentRequest.status === 'pending') {
        packageBtn.style.display = 'inline-block';
    } else {
        packageBtn.style.display = 'none';
    }
    
    document.getElementById('serviceModal').style.display = 'block';
}

// Close service detail modal
function closeServiceModal() {
    document.getElementById('serviceModal').style.display = 'none';
    currentRequest = null;
}

// Show status update modal
function showStatusUpdate() {
    if (!currentRequest) return;
    
    document.getElementById('newStatus').value = currentRequest.status;
    document.getElementById('statusNote').value = '';
    document.getElementById('statusModal').style.display = 'block';
}

// Close status update modal
function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
}

// Open package opening station for selected request
function openPackageStation() {
    if (!currentRequest) return;
    
    // Set the request ID in localStorage for the package opening page to use
    localStorage.setItem('preselected_request_id', currentRequest.id);
    
    // Open package opening page in new tab
    window.open('/package-opening.html', '_blank');
    
    closeServiceModal();
}

// Start processing request - direct to package opening
function startProcessing(requestId) {
    // Set the request ID in localStorage for the package opening page to use
    localStorage.setItem('preselected_request_id', requestId);
    
    // Open package opening page in new tab
    window.open('/package-opening.html', '_blank');
}

// Quick status update
async function quickStatusUpdate(requestId) {
    currentRequest = allRequests.find(r => r.id === requestId);
    if (!currentRequest) return;
    
    showStatusUpdate();
}

// Update service status
async function updateServiceStatus() {
    if (!currentRequest) return;
    
    const newStatus = document.getElementById('newStatus').value;
    const statusNote = document.getElementById('statusNote').value;
    
    if (!newStatus) {
        alert('L√ºtfen yeni durum se√ßiniz');
        return;
    }
    
    try {
        const response = await fetch(`/api/service-requests/${currentRequest.id}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: newStatus,
                note: statusNote
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ Durum g√ºncellendi:', data);
            closeStatusModal();
            closeServiceModal();
            loadServiceRequests(); // Refresh data
            showSuccess('Servis durumu ba≈üarƒ±yla g√ºncellendi');
        } else {
            throw new Error(data.error || 'Durum g√ºncellenemedi');
        }
    } catch (error) {
        console.error('‚ùå Durum g√ºncelleme hatasƒ±:', error);
        showError('Durum g√ºncellenirken hata olu≈ütu: ' + error.message);
    }
}

// Utility functions
function truncateText(text, maxLength) {
    if (!text) return '-';
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

function getPriorityText(priority) {
    const priorities = {
        urgent: 'Acil',
        high: 'Y√ºksek', 
        normal: 'Normal',
        low: 'D√º≈ü√ºk'
    };
    return priorities[priority] || priority;
}

function getStatusText(status) {
    const statuses = {
        new: 'Yeni',
        pending: 'Beklemede',
        sourcing: 'Par√ßa Temin',
        package_opening: 'Paket A√ßma',
        ssh_storage: 'SSH Depolama',
        factory_order: 'Fabrika Sipari≈ü',
        completed: 'Tamamlandƒ±',
        cancelled: 'ƒ∞ptal'
    };
    return statuses[status] || status;
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('tr-TR');
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('tr-TR');
}

function showSuccess(message) {
    alert('‚úÖ ' + message);
}

function showError(message) {
    alert('‚ùå ' + message);
}

// Modal click outside to close
window.onclick = function(event) {
    const serviceModal = document.getElementById('serviceModal');
    const statusModal = document.getElementById('statusModal');
    
    if (event.target === serviceModal) {
        closeServiceModal();
    }
    if (event.target === statusModal) {
        closeStatusModal();
    }
}

// Mobile navigation toggle
document.getElementById('mobileNavToggle').addEventListener('click', () => {
  const menu = document.getElementById('mobileNavMenu');
  menu.classList.toggle('show');
});

// Close mobile menu when clicking outside
document.addEventListener('click', (e) => {
  const nav = document.getElementById('mobileNav');
  const menu = document.getElementById('mobileNavMenu');
  if (!nav.contains(e.target)) {
    menu.classList.remove('show');
  }
});
</script>
</body>
</html>