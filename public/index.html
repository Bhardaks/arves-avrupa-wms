
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>WMS Netsis Entegre Dashboard</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
  <style>
    /* Dropdown Navigation Styles */
    .main-nav {
      display: flex;
      align-items: center;
      gap: 0;
      background: var(--header-bg, #1e293b);
    }
    
    .nav-link.standalone {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      text-decoration: none;
      color: var(--header-fg, #e2e8f0);
      transition: all 0.2s ease;
      border-right: 1px solid rgba(255,255,255,0.1);
    }
    
    .nav-link.standalone:hover {
      background: rgba(255,255,255,0.1);
      color: var(--accent, #3b82f6);
    }
    
    .nav-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .nav-dropdown-trigger {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      cursor: pointer;
      color: var(--header-fg, #e2e8f0);
      transition: all 0.2s ease;
      border-right: 1px solid rgba(255,255,255,0.1);
      user-select: none;
    }
    
    .nav-dropdown-trigger:hover {
      background: rgba(255,255,255,0.1);
      color: var(--accent, #3b82f6);
    }
    
    .nav-dropdown:hover .nav-dropdown-trigger {
      background: rgba(255,255,255,0.1);
      color: var(--accent, #3b82f6);
    }
    
    .dropdown-arrow {
      margin-left: 8px;
      font-size: 10px;
      transition: transform 0.2s ease;
    }
    
    .nav-dropdown:hover .dropdown-arrow {
      transform: rotate(180deg);
    }
    
    .nav-dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      min-width: 220px;
      background: var(--card, #ffffff);
      border: 1px solid var(--border, #e5e7eb);
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow: hidden;
    }
    
    .nav-dropdown:hover .nav-dropdown-content {
      display: block;
      animation: dropdownFadeIn 0.2s ease;
    }
    
    @keyframes dropdownFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .nav-dropdown-link {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      text-decoration: none;
      color: var(--fg, #374151);
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--border, #f3f4f6);
    }
    
    .nav-dropdown-link:last-child {
      border-bottom: none;
    }
    
    .nav-dropdown-link:hover {
      background: var(--hover, #f8fafc);
      color: var(--accent, #3b82f6);
    }
    
    .nav-icon {
      margin-right: 10px;
      font-size: 16px;
    }
    
    .nav-text {
      font-weight: 500;
      font-size: 14px;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .main-nav {
        display: none;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="header-brand">
    <h1>WMS Netsis Entegre</h1>
    <span class="header-subtitle">Depo Yönetim + ERP Entegrasyon Paneli</span>
  </div>
  <div class="header-user">
    <div class="user-info" id="userInfo" style="display: none;">
      <span class="user-name" id="userName"></span>
      <span class="user-role" id="userRole"></span>
      <button class="logout-btn" id="logoutBtn">Çıkış</button>
    </div>
  </div>
  <nav class="main-nav">
    <!-- Ana Sayfa linki -->
    <a href="/index.html" class="nav-link standalone">
      <span class="nav-icon">🏠</span>
      <span class="nav-text">Ana Sayfa</span>
    </a>
    
    <!-- Ana Modüller Dropdown -->
    <div class="nav-dropdown">
      <div class="nav-dropdown-trigger">
        <span class="nav-icon">📊</span>
        <span class="nav-text">Ana Modüller</span>
        <span class="dropdown-arrow">▼</span>
      </div>
      <div class="nav-dropdown-content">
        <a href="/products.html" class="nav-dropdown-link">
          <span class="nav-icon">📦</span>
          <span class="nav-text">Ürünler</span>
        </a>
        <a href="/orders.html" class="nav-dropdown-link">
          <span class="nav-icon">📋</span>
          <span class="nav-text">Siparişler</span>
        </a>
        <a href="/delivery-confirmation.html" class="nav-dropdown-link">
          <span class="nav-icon">🚚</span>
          <span class="nav-text">Teslimat İşlemleri</span>
        </a>
      </div>
    </div>
    
    <!-- Raf Yönetimi Dropdown -->
    <div class="nav-dropdown">
      <div class="nav-dropdown-trigger">
        <span class="nav-icon">🏬</span>
        <span class="nav-text">Raf Yönetimi</span>
        <span class="dropdown-arrow">▼</span>
      </div>
      <div class="nav-dropdown-content">
        <a href="/shelf-scanner.html" class="nav-dropdown-link">
          <span class="nav-icon">🔍</span>
          <span class="nav-text">Rafa Dizim</span>
        </a>
        <a href="/shelf-locations.html" class="nav-dropdown-link">
          <span class="nav-icon">📍</span>
          <span class="nav-text">Lokasyonlar</span>
        </a>
        <a href="/shelf-admin.html" class="nav-dropdown-link">
          <span class="nav-icon">⚙️</span>
          <span class="nav-text">Raf Yönetimi</span>
        </a>
        <a href="/shelf-transfer.html" class="nav-dropdown-link">
          <span class="nav-icon">🔄</span>
          <span class="nav-text">Raflar Arası Transfer</span>
        </a>
        <a href="/inventory-count.html" class="nav-dropdown-link">
          <span class="nav-icon">📊</span>
          <span class="nav-text">Depo Sayım</span>
        </a>
        <a href="/stock-management.html" class="nav-dropdown-link">
          <span class="nav-icon">📈</span>
          <span class="nav-text">Stok Yönetimi</span>
        </a>
      </div>
    </div>
    
    <!-- SSH Servis Dropdown -->
    <div class="nav-dropdown">
      <div class="nav-dropdown-trigger">
        <span class="nav-icon">🔧</span>
        <span class="nav-text">SSH Servis</span>
        <span class="dropdown-arrow">▼</span>
      </div>
      <div class="nav-dropdown-content">
        <a href="/service-request.html" class="nav-dropdown-link">
          <span class="nav-icon">🔧</span>
          <span class="nav-text">Servis Talep</span>
        </a>
        <a href="/service-dashboard.html" class="nav-dropdown-link">
          <span class="nav-icon">📊</span>
          <span class="nav-text">Servis Dashboard</span>
        </a>
        <a href="/ssh-inventory.html" class="nav-dropdown-link">
          <span class="nav-icon">📋</span>
          <span class="nav-text">SSH Envanter</span>
        </a>
      </div>
    </div>

    <!-- Raporlama Dropdown -->
    <div class="nav-dropdown">
      <div class="nav-dropdown-trigger">
        <span class="nav-icon">📈</span>
        <span class="nav-text">Raporlama</span>
        <span class="dropdown-arrow">▼</span>
      </div>
      <div class="nav-dropdown-content">
        <a href="/reports.html" class="nav-dropdown-link">
          <span class="nav-icon">📊</span>
          <span class="nav-text">Stok Raporları</span>
        </a>
      </div>
    </div>
  </nav>
  <div id="mobileNav" class="mobile-nav">
    <button id="mobileNavToggle" class="mobile-nav-toggle">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    <div id="mobileNavMenu" class="mobile-nav-menu">
      <div class="mobile-nav-header">
        <h3>WMS Sistemi</h3>
      </div>
      <div class="mobile-nav-group">
        <span class="mobile-nav-group-label">Ana Modüller</span>
        <a href="/index.html" class="mobile-nav-link">
          <span class="nav-icon">🏠</span>
          <span class="nav-text">Ana Sayfa</span>
        </a>
        <a href="/products.html" class="mobile-nav-link">
          <span class="nav-icon">📦</span>
          <span class="nav-text">Ürünler</span>
        </a>
        <a href="/orders.html" class="mobile-nav-link">
          <span class="nav-icon">📋</span>
          <span class="nav-text">Siparişler</span>
        </a>
        <a href="/delivery-confirmation.html" class="mobile-nav-link">
          <span class="nav-icon">🚚</span>
          <span class="nav-text">Teslimat İşlemleri</span>
        </a>
      </div>
      <div class="mobile-nav-group">
        <span class="mobile-nav-group-label">Raf Yönetimi</span>
        <a href="/shelf-scanner.html" class="mobile-nav-link">
          <span class="nav-icon">🔍</span>
          <span class="nav-text">Rafa Dizim</span>
        </a>
        <a href="/shelf-locations.html" class="mobile-nav-link">
          <span class="nav-icon">📍</span>
          <span class="nav-text">Lokasyonlar</span>
        </a>
        <a href="/shelf-admin.html" class="mobile-nav-link">
          <span class="nav-icon">⚙️</span>
          <span class="nav-text">Raf Yönetimi</span>
        </a>
        <a href="/shelf-transfer.html" class="mobile-nav-link">
          <span class="nav-icon">🔄</span>
          <span class="nav-text">Raflar Arası Transfer</span>
        </a>
        <a href="/inventory-count.html" class="mobile-nav-link">
          <span class="nav-icon">📊</span>
          <span class="nav-text">Depo Sayım</span>
        </a>
      </div>
      <div class="mobile-nav-group">
        <span class="mobile-nav-group-label">SSH Servis</span>
        <a href="/service-request.html" class="mobile-nav-link">
          <span class="nav-icon">🔧</span>
          <span class="nav-text">Servis Talep</span>
        </a>
        <a href="/service-dashboard.html" class="mobile-nav-link">
          <span class="nav-icon">📊</span>
          <span class="nav-text">Servis Dashboard</span>
        </a>
        <a href="/ssh-inventory.html" class="mobile-nav-link">
          <span class="nav-icon">📋</span>
          <span class="nav-text">SSH Envanter</span>
        </a>
      </div>
      <div class="mobile-nav-group">
        <span class="mobile-nav-group-label">Raporlama</span>
        <a href="/reports.html" class="mobile-nav-link">
          <span class="nav-icon">📈</span>
          <span class="nav-text">Stok Raporları</span>
        </a>
      </div>
    </div>
  </div>
</header>

<main class="dashboard">
  <!-- İstatistikler -->
  <section class="stats-grid">
    <div class="stat-card">
      <h3>Toplam Ürün</h3>
      <div class="stat-number" id="totalProducts">-</div>
      <div class="stat-label">Adet</div>
    </div>
    <div class="stat-card">
      <h3>Bekleyen Siparişler</h3>
      <div class="stat-number" id="pendingOrders">-</div>
      <div class="stat-label">Sipariş</div>
    </div>
    <div class="stat-card">
      <h3>Toplam Raf</h3>
      <div class="stat-number" id="totalShelves">-</div>
      <div class="stat-label">Raf</div>
    </div>
    <div class="stat-card">
      <h3>Sistem Durumu</h3>
      <div class="stat-number" id="systemStatus">-</div>
      <div class="stat-label">Status</div>
    </div>
  </section>

  <!-- Modül Grupları -->
  <section class="modules-grid">
    <!-- Ana Modüller -->
    <div class="module-group">
      <h2>📊 Ana Modüller</h2>
      <div class="module-cards">
        <a href="/products.html" class="module-card">
          <div class="module-icon">📦</div>
          <div class="module-info">
            <h3>Ürün Yönetimi</h3>
            <p>Ürün kayıt, güncelleme ve stok takibi</p>
          </div>
        </a>
        <a href="/orders.html" class="module-card">
          <div class="module-icon">📋</div>
          <div class="module-info">
            <h3>Sipariş Yönetimi</h3>
            <p>Sipariş işleme ve durum takibi</p>
          </div>
        </a>
        <a href="/delivery-confirmation.html" class="module-card">
          <div class="module-icon">🚚</div>
          <div class="module-info">
            <h3>Teslimat İşlemleri</h3>
            <p>Teslimat kayıtları ve onay işlemleri</p>
          </div>
        </a>
      </div>
    </div>

    <!-- Raf Yönetimi -->
    <div class="module-group">
      <h2>🏬 Raf Yönetimi</h2>
      <div class="module-cards">
        <a href="/shelf-scanner.html" class="module-card">
          <div class="module-icon">🔍</div>
          <div class="module-info">
            <h3>Rafa Dizim</h3>
            <p>Barkod okuma ve raf sorguları</p>
          </div>
        </a>
        <a href="/shelf-locations.html" class="module-card">
          <div class="module-icon">📍</div>
          <div class="module-info">
            <h3>Lokasyon Haritası</h3>
            <p>Raf konumları ve analitik dashboard</p>
          </div>
        </a>
        <a href="/shelf-admin.html" class="module-card">
          <div class="module-icon">⚙️</div>
          <div class="module-info">
            <h3>Raf Yönetimi</h3>
            <p>Raf oluşturma ve düzenleme</p>
          </div>
        </a>
        <a href="/shelf-transfer.html" class="module-card">
          <div class="module-icon">🔄</div>
          <div class="module-info">
            <h3>Raflar Arası Transfer</h3>
            <p>Paketleri raflar arasında taşı</p>
          </div>
        </a>
        <a href="/inventory-count.html" class="module-card">
          <div class="module-icon">📊</div>
          <div class="module-info">
            <h3>Depo Sayım</h3>
            <p>Stok sayım ve envanter kontrolü</p>
          </div>
        </a>
        <a href="/stock-management.html" class="module-card">
          <div class="module-icon">📈</div>
          <div class="module-info">
            <h3>Stok Yönetimi</h3>
            <p>Stok seviyeleri ve hareket takibi</p>
          </div>
        </a>
      </div>
    </div>

    <!-- SSH Servis -->
    <div class="module-group">
      <h2>🔧 SSH Servis Hub</h2>
      <div class="module-cards">
        <a href="/service-request.html" class="module-card">
          <div class="module-icon">🔧</div>
          <div class="module-info">
            <h3>Servis Talep</h3>
            <p>Müşteri servis taleplerini oluştur</p>
          </div>
        </a>
        <a href="/service-dashboard.html" class="module-card">
          <div class="module-icon">📊</div>
          <div class="module-info">
            <h3>Servis Dashboard</h3>
            <p>Servis talep durumları ve işlemler</p>
          </div>
        </a>
        <a href="/ssh-inventory.html" class="module-card">
          <div class="module-icon">📋</div>
          <div class="module-info">
            <h3>SSH Envanter</h3>
            <p>SSH alanı stok takibi</p>
          </div>
        </a>
      </div>
    </div>
  </section>

  <!-- Raporlama -->
  <div class="module-group">
    <h2>📈 Raporlama ve Analitik</h2>
    <div class="module-cards">
      <a href="/reports.html" class="module-card">
        <div class="module-icon">📊</div>
        <div class="module-info">
          <h3>Stok Raporları</h3>
          <p>Envanter durumu ve hareket raporları</p>
        </div>
      </a>
      <a href="/reports.html#low-stock" class="module-card">
        <div class="module-icon">⚠️</div>
        <div class="module-info">
          <h3>Düşük Stok Uyarısı</h3>
          <p>Kritik seviyedeki ürünleri görüntüle</p>
        </div>
      </a>
      <a href="/reports.html#abc-analysis" class="module-card">
        <div class="module-icon">🔤</div>
        <div class="module-info">
          <h3>ABC Analizi</h3>
          <p>Ürün performans sınıflandırması</p>
        </div>
      </a>
      <a href="/reports.html#stock-movement" class="module-card">
        <div class="module-icon">🔄</div>
        <div class="module-info">
          <h3>Stok Hareketleri</h3>
          <p>Giriş/çıkış hareket raporları</p>
        </div>
      </a>
      <a href="/reports.html#variance" class="module-card">
        <div class="module-icon">📋</div>
        <div class="module-info">
          <h3>Sayım Varyansı</h3>
          <p>Envanter sayım sonuç analizleri</p>
        </div>
      </a>
    </div>
  </div>

  <!-- Sistem Yönetimi -->
  <section class="card">
    <h2>🛠️ Sistem Yönetimi</h2>
    <div class="system-management">
      <div class="management-actions">
        <a href="/admin-panel.html" class="action-btn admin-panel-link">
          <span class="btn-icon">👥</span>
          <span class="btn-text">Admin Panel</span>
        </a>
        <a href="/role-management.html" class="action-btn admin-panel-link">
          <span class="btn-icon">🔐</span>
          <span class="btn-text">Rol İzinleri</span>
        </a>
        <button class="action-btn" id="checkHealth">
          <span class="btn-icon">🏥</span>
          <span class="btn-text">Sistem Durumu</span>
        </button>
      </div>
      <div class="sync-status">
        <h4>Senkronizasyon Durumu</h4>
        <div id="syncStatus" class="sync-info">
          <div>Son Ürün Sync: <span id="lastProductSync">-</span></div>
          <div>Son Sipariş Sync: <span id="lastOrderSync">-</span></div>
        </div>
      </div>
      <pre id="healthOut" class="health-output" style="display: none;"></pre>
    </div>
  </section>

  <!-- Son İşlemler -->
  <section class="card">
    <h2>📋 Son İşlemler</h2>
    <div class="recent-activities">
      <div id="recentOrders" class="activity-section">
        <h3>Son Siparişler</h3>
        <div class="activity-list" id="recentOrdersList">Yükleniyor...</div>
      </div>
      <div id="recentShelves" class="activity-section">
        <h3>Raf İstatistikleri</h3>
        <div class="activity-list" id="recentShelvesList">Yükleniyor...</div>
      </div>
    </div>
  </section>
</main>

<script type="module">
const API = {
  health: () => fetch('/api/health').then(r => r.json()),
  products: () => fetch('/api/products').then(r => r.json()),
  orders: () => fetch('/api/orders').then(r => r.json()),
  shelves: () => fetch('/api/shelves').then(r => r.json()),
  
  // Auth API
  checkAuth: () => fetch('/api/auth/check', { credentials: 'include' }).then(r => r.json()),
  logout: () => fetch('/api/auth/logout', { 
    method: 'POST', 
    credentials: 'include' 
  }).then(r => r.json()),
  getRolePermissions: (role) => fetch(`/api/role-permissions/${role}`, { credentials: 'include' }).then(r => r.json())
};

// Role permissions
const ROLE_PERMISSIONS = {
  admin: ['products', 'orders', 'shelf', 'service', 'system'],
  operator: ['products', 'orders', 'shelf'],
  service: ['service']
};

// Authentication kontrolü
async function checkAuthentication() {
  try {
    const authCheck = await API.checkAuth();
    if (!authCheck.authenticated) {
      window.location.href = '/login.html';
      return false;
    }
    
    // Dynamic role permissions yükle
    await loadDynamicRolePermissions(authCheck.user.role);
    
    // User bilgilerini göster
    document.getElementById('userName').textContent = authCheck.user.full_name || authCheck.user.username;
    document.getElementById('userRole').textContent = getRoleDisplayName(authCheck.user.role);
    document.getElementById('userInfo').style.display = 'flex';
    
    // Role bazında menü kontrolü
    applyRoleBasedAccess(authCheck.user.role);
    
    return authCheck.user;
  } catch (error) {
    console.error('Auth check error:', error);
    window.location.href = '/login.html';
    return false;
  }
}

// Dynamic role permissions yükle
async function loadDynamicRolePermissions(role) {
  try {
    console.log('INDEX: Loading dynamic permissions for role:', role);
    const result = await API.getRolePermissions(role);
    console.log('INDEX: API response:', result);
    
    if (result.success) {
      // Convert {permission: boolean} to [permission] array for enabled permissions
      const enabledPermissions = Object.entries(result.permissions)
        .filter(([permission, enabled]) => enabled)
        .map(([permission]) => permission);
      
      ROLE_PERMISSIONS[role] = enabledPermissions;
      console.log('INDEX: Dynamic permissions loaded:', enabledPermissions);
    } else {
      console.error('Failed to load role permissions:', result.message);
      // Keep existing static permissions as fallback
    }
  } catch (error) {
    console.error('Error loading dynamic role permissions:', error);
    // Keep existing static permissions as fallback
  }
}

function getRoleDisplayName(role) {
  const roleNames = {
    admin: 'Yönetici',
    operator: 'Operatör',
    service: 'Servis Teknisyeni'
  };
  return roleNames[role] || role;
}

// Role bazında menü erişim kontrolü - Hiyerarşik izinlerle güncellendi
function applyRoleBasedAccess(userRole) {
  const permissions = ROLE_PERMISSIONS[userRole] || [];
  
  // Detailed permission mapping for menu items - Granular SSH control
  const menuPermissionMap = {
    '/products.html': ['products', 'products.view', 'products.create', 'products.edit'],
    '/orders.html': ['orders', 'orders.view', 'orders.create', 'orders.edit'],
    '/shelf-scanner.html': ['shelf', 'shelf.scanner', 'shelf.assign'],
    '/shelf-locations.html': ['shelf', 'shelf.locations', 'shelf.view'],
    '/shelf-admin.html': ['shelf', 'shelf.admin', 'shelf.manage'],
    '/shelf-transfer.html': ['shelf', 'shelf.transfer', 'shelf.move'],
    '/inventory-count.html': ['shelf', 'shelf.inventory', 'shelf.count'],
    '/stock-management.html': ['shelf', 'shelf.stock', 'shelf.analytics'],
    
    // SSH Servis - Alt bölüm bazında kontrol
    '/service-request.html': ['service.requests', 'service.create'], // Sadece servis talepleri iznine bakacak
    '/service-dashboard.html': ['service.dashboard', 'service.view'], // Sadece dashboard iznine bakacak
    '/ssh-inventory.html': ['service.ssh_inventory', 'service.inventory'] // Sadece SSH envanter iznine bakacak
  };
  
  // Check each menu link with granular permission control - Updated for dropdown navigation
  Object.entries(menuPermissionMap).forEach(([href, requiredPerms]) => {
    const links = document.querySelectorAll(`a[href="${href}"]`);
    links.forEach(link => {
      const parent = link.closest('.module-card') || link.closest('.nav-link') || link.closest('.mobile-nav-link') || link.closest('.nav-dropdown-link');
      if (parent) {
        const hasAccess = requiredPerms.some(perm => permissions.includes(perm));
        parent.style.display = hasAccess ? '' : 'none';
        
        // Debug için log
        if (href.includes('service') || href.includes('ssh')) {
          console.log(`SSH Menu Check - ${href}: Required [${requiredPerms.join(', ')}], Has Access: ${hasAccess}`, permissions);
        }
      }
    });
  });
  
  // SSH Servis Modül Grubu - En az bir SSH alt iznine sahipse göster
  const sshServiceGroup = document.querySelector('.module-group:has(a[href*="service"], a[href*="ssh"])');
  if (sshServiceGroup) {
    const sshPermissions = ['service.requests', 'service.create', 'service.dashboard', 'service.view', 'service.ssh_inventory', 'service.inventory'];
    const hasSshAccess = sshPermissions.some(perm => permissions.includes(perm));
    
    // SSH modül grubunu göster/gizle
    sshServiceGroup.style.display = hasSshAccess ? '' : 'none';
    console.log('SSH Group Access Check:', hasSshAccess, sshPermissions, permissions);
  }
  
  // Sistem Yönetimi kontrolü (detaylı alt izinlerle)
  const systemManagement = document.querySelector('.system-management');
  if (systemManagement) {
    const systemPermissions = ['system', 'system.admin_panel', 'system.manage_users', 'system.manage_roles'];
    const hasSystemAccess = systemPermissions.some(perm => permissions.includes(perm));
    systemManagement.style.display = hasSystemAccess ? '' : 'none';
    
    // Admin panel link kontrolü
    const adminPanelLink = systemManagement.querySelector('.admin-panel-link[href="/admin-panel.html"]');
    if (adminPanelLink) {
      const adminPerms = ['system', 'system.admin_panel', 'system.manage_users'];
      const hasAdminAccess = adminPerms.some(perm => permissions.includes(perm));
      adminPanelLink.style.display = hasAdminAccess ? '' : 'none';
    }
    
    // Role management link kontrolü
    const roleManagementLink = systemManagement.querySelector('.admin-panel-link[href="/role-management.html"]');
    if (roleManagementLink) {
      const rolePerms = ['system', 'system.manage_roles', 'system.manage_permissions'];
      const hasRoleAccess = rolePerms.some(perm => permissions.includes(perm));
      roleManagementLink.style.display = hasRoleAccess ? '' : 'none';
    }
  }
  
  // Modül gruplarını gizle/göster (SSH özel kontrolü hariç)
  const moduleGroups = document.querySelectorAll('.module-group');
  moduleGroups.forEach(group => {
    // SSH servis grubu için özel kontrol yapıldı yukarıda, diğerleri için normal kontrol
    const isSSHGroup = group.querySelector('a[href*="service"], a[href*="ssh"]');
    if (!isSSHGroup) {
      const visibleCards = group.querySelectorAll('.module-card:not([style*="display: none"])');
      if (visibleCards.length === 0) {
        group.style.display = 'none';
      } else {
        group.style.display = '';
      }
    }
  });
  
  // Dropdown navigation permissions - New dropdown system
  const dropdowns = document.querySelectorAll('.nav-dropdown');
  dropdowns.forEach(dropdown => {
    // Ana Modüller dropdown kontrolü
    const isMainModules = dropdown.querySelector('.nav-dropdown-trigger .nav-text').textContent.includes('Ana Modüller');
    if (isMainModules) {
      const mainPermissions = ['products', 'orders', 'products.view', 'orders.view'];
      const hasMainAccess = mainPermissions.some(perm => permissions.includes(perm));
      dropdown.style.display = hasMainAccess ? '' : 'none';
      
      // Ana modüller dropdown içindeki linklerin görünürlüğü zaten yukarıda kontrol ediliyor
      // Hiç görünür link yoksa dropdown'u gizle
      setTimeout(() => {
        const visibleLinks = dropdown.querySelectorAll('.nav-dropdown-link:not([style*="display: none"])');
        if (visibleLinks.length === 0) {
          dropdown.style.display = 'none';
        }
      }, 10);
    }
    
    // Raf Yönetimi dropdown kontrolü
    const isShelfManagement = dropdown.querySelector('.nav-dropdown-trigger .nav-text').textContent.includes('Raf Yönetimi');
    if (isShelfManagement) {
      const shelfPermissions = ['shelf', 'shelf.scanner', 'shelf.view', 'shelf.admin', 'shelf.manage', 'shelf.transfer', 'shelf.inventory', 'shelf.stock'];
      const hasShelfAccess = shelfPermissions.some(perm => permissions.includes(perm));
      dropdown.style.display = hasShelfAccess ? '' : 'none';
      
      // Raf yönetimi dropdown içindeki linklerin görünürlüğü zaten yukarıda kontrol ediliyor
      setTimeout(() => {
        const visibleLinks = dropdown.querySelectorAll('.nav-dropdown-link:not([style*="display: none"])');
        if (visibleLinks.length === 0) {
          dropdown.style.display = 'none';
        }
      }, 10);
    }
    
    // SSH Servis dropdown kontrolü
    const isSSHService = dropdown.querySelector('.nav-dropdown-trigger .nav-text').textContent.includes('SSH Servis');
    if (isSSHService) {
      const sshPermissions = ['service.requests', 'service.create', 'service.dashboard', 'service.view', 'service.ssh_inventory', 'service.inventory'];
      const hasSshAccess = sshPermissions.some(perm => permissions.includes(perm));
      dropdown.style.display = hasSshAccess ? '' : 'none';
      console.log('SSH Dropdown Access Check:', hasSshAccess, sshPermissions, permissions);
      
      // SSH servis dropdown içindeki linklerin görünürlüğü zaten yukarıda kontrol ediliyor
      setTimeout(() => {
        const visibleLinks = dropdown.querySelectorAll('.nav-dropdown-link:not([style*="display: none"])');
        if (visibleLinks.length === 0) {
          dropdown.style.display = 'none';
        }
      }, 10);
    }
  });

  // Nav gruplarını gizle/göster (SSH özel kontrolü) - Legacy support for mobile nav
  const navGroups = document.querySelectorAll('.nav-group, .mobile-nav-group');
  navGroups.forEach(group => {
    const isSSHNavGroup = group.querySelector('a[href*="service"], a[href*="ssh"]');
    if (isSSHNavGroup) {
      // SSH nav grubu için - en az bir SSH alt iznine sahipse göster
      const sshPermissions = ['service.requests', 'service.create', 'service.dashboard', 'service.view', 'service.ssh_inventory', 'service.inventory'];
      const hasSshAccess = sshPermissions.some(perm => permissions.includes(perm));
      group.style.display = hasSshAccess ? '' : 'none';
    } else {
      // Diğer nav grupları için normal kontrol
      const visibleLinks = group.querySelectorAll('.nav-link:not([style*="display: none"]), .mobile-nav-link:not([style*="display: none"])');
      if (visibleLinks.length === 0) {
        group.style.display = 'none';
      } else {
        group.style.display = '';
      }
    }
  });
}

// Dashboard verilerini yükle
async function loadDashboard() {
  try {
    // İstatistikleri yükle
    const [health, products, orders, shelves] = await Promise.all([
      API.health(),
      API.products(),
      API.orders(),
      API.shelves()
    ]);

    // Toplam ürün sayısı
    document.getElementById('totalProducts').textContent = products.length;

    // Bekleyen siparişler (open, approved durumunda olanlar)
    const pendingCount = orders.filter(o => ['open', 'approved'].includes(o.status)).length;
    document.getElementById('pendingOrders').textContent = pendingCount;

    // Sistem durumu
    document.getElementById('systemStatus').textContent = health.status === 'ok' ? '✅' : '❌';

    // Toplam raf sayısı
    document.getElementById('totalShelves').textContent = shelves.shelves ? shelves.shelves.length : 0;

    // Son siparişleri göster
    const recentOrdersHtml = orders.slice(0, 5).map(order => `
      <div class="activity-item">
        <div class="activity-text">
          <strong>${order.order_number}</strong> - ${order.customer_name || 'Anonim'}
        </div>
        <div class="activity-status status-${order.status}">${order.status}</div>
      </div>
    `).join('');
    document.getElementById('recentOrdersList').innerHTML = recentOrdersHtml;

    // Raf istatistikleri
    document.getElementById('recentShelvesList').innerHTML = `
      <div class="activity-item">
        <div class="activity-text">Dolu Raflar: 8</div>
        <div class="activity-status status-active">Aktif</div>
      </div>
      <div class="activity-item">
        <div class="activity-text">Boş Raflar: 4</div>
        <div class="activity-status status-pending">Bekleyen</div>
      </div>
    `;

  } catch (error) {
    console.error('Dashboard yükleme hatası:', error);
    document.getElementById('totalProducts').textContent = 'Hata';
    document.getElementById('pendingOrders').textContent = 'Hata';
    document.getElementById('systemStatus').textContent = '❌';
  }
}

// Sunucu durumu kontrolü
document.getElementById('checkHealth').addEventListener('click', async () => {
  try {
    const health = await API.health();
    const healthOut = document.getElementById('healthOut');
    healthOut.textContent = JSON.stringify(health, null, 2);
    healthOut.style.display = 'block';
    document.getElementById('systemStatus').textContent = health.status === 'ok' ? '✅' : '❌';
  } catch (error) {
    const healthOut = document.getElementById('healthOut');
    healthOut.textContent = 'Sunucu erişilemez: ' + error.message;
    healthOut.style.display = 'block';
    document.getElementById('systemStatus').textContent = '❌';
  }
});


// Mobile navigation toggle
document.getElementById('mobileNavToggle').addEventListener('click', () => {
  const menu = document.getElementById('mobileNavMenu');
  menu.classList.toggle('show');
});

// Close mobile menu when clicking outside
document.addEventListener('click', (e) => {
  const nav = document.getElementById('mobileNav');
  const menu = document.getElementById('mobileNavMenu');
  if (!nav.contains(e.target)) {
    menu.classList.remove('show');
  }
});

// Logout işlemi
document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    await API.logout();
    window.location.href = '/login.html';
  } catch (error) {
    console.error('Logout error:', error);
    window.location.href = '/login.html';
  }
});

// Sayfa yüklendiğinde authentication kontrolü ve dashboard'u yükle
document.addEventListener('DOMContentLoaded', async () => {
  const user = await checkAuthentication();
  if (user) {
    await loadDashboard();
  }
});

// Her 30 saniyede bir otomatik yenile
setInterval(loadDashboard, 30000);
</script>
</body>
</html>
