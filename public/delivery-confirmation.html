<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Teslimat Kanıtı</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
  <script src="/assets/js/auth.js"></script>
  <style>
    /* Global mobile overflow fix */
    html, body {
      max-width: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    
    *, *:before, *:after {
      box-sizing: border-box;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
    }
    .tab-btn {
      background: none;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
    }
    .tab-btn:hover {
      background-color: #f5f5f5;
    }
    .tab-btn.active {
      border-bottom-color: #007bff;
      color: #007bff;
    }
    .table-container {
      overflow-x: auto;
    }
    
    /* Desktop table optimizations */
    @media (min-width: 769px) {
      table {
        table-layout: fixed;
        width: 100%;
      }
      
      th:nth-child(1), td:nth-child(1) { width: 12%; } /* Sipariş No */
      th:nth-child(2), td:nth-child(2) { width: 20%; } /* Müşteri */
      th:nth-child(3), td:nth-child(3) { width: 12%; } /* Durum */
      th:nth-child(4), td:nth-child(4) { width: 25%; } /* Kalemler */
      th:nth-child(5), td:nth-child(5) { width: 15%; } /* Tarih */
      th:nth-child(6), td:nth-child(6) { width: 16%; } /* İşlem */
      
      .action-btn {
        width: 100%;
        max-width: none;
      }
    }
    
    /* Mobile optimizations - clean card layout */
    @media (max-width: 768px) {
      /* Site header mobile fixes */
      header {
        padding: 12px 16px;
        flex-wrap: nowrap;
      }
      
      header h1 {
        font-size: 18px;
        margin: 0;
        flex-shrink: 0;
      }
      
      header nav {
        display: none;
      }
      
      /* COMPLETE FILTER OVERRIDE FOR MOBILE */
      .filters-mobile {
        display: block !important;
        width: 100% !important;
        margin: 0 0 20px 0 !important;
        padding: 0 !important;
        background: none !important;
        border: none !important;
        flex: none !important;
        gap: 0 !important;
        flex-direction: column !important;
        align-items: stretch !important;
        justify-content: flex-start !important;
        flex-wrap: nowrap !important;
      }
      
      .filters-mobile * {
        float: none !important;
        position: static !important;
        transform: none !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        left: auto !important;
        right: auto !important;
        top: auto !important;
        bottom: auto !important;
      }
      
      .filters-mobile input,
      .filters-mobile select,
      .filters-mobile button {
        display: block !important;
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        margin: 0 0 12px 0 !important;
        padding: 12px 16px !important;
        font-size: 16px !important;
        border: 2px solid #ddd !important;
        border-radius: 8px !important;
        background: #0e1a30 !important;
        color: var(--fg) !important;
        box-sizing: border-box !important;
        flex: none !important;
        position: relative !important;
        clear: both !important;
      }
      
      .filters-mobile input:focus,
      .filters-mobile select:focus {
        border-color: var(--accent) !important;
        outline: none !important;
      }
      /* Reset everything for mobile */
      .table-container {
        overflow: visible;
        margin: 0;
        padding: 0;
      }
      
      table {
        display: none !important;
      }
      
      /* Mobile card layout */
      .mobile-orders {
        display: block !important;
      }
      
      .order-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        margin-bottom: 16px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .order-number {
        font-size: 16px;
        font-weight: bold;
        color: var(--accent);
      }
      
      .order-status {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 500;
      }
      
      .order-info {
        margin-bottom: 12px;
      }
      
      .info-row {
        display: flex;
        margin-bottom: 8px;
        align-items: flex-start;
      }
      
      .info-label {
        font-weight: 600;
        color: var(--muted);
        min-width: 70px;
        font-size: 13px;
      }
      
      .info-value {
        flex: 1;
        font-size: 14px;
        line-height: 1.3;
      }
      
      .order-items-mobile {
        background: var(--hover);
        border-radius: 6px;
        padding: 8px;
        margin: 8px 0;
        font-size: 13px;
        line-height: 1.4;
      }
      
      .mobile-action-btn {
        width: 100%;
        padding: 12px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 8px;
      }
      
      .btn-primary-mobile {
        background: var(--accent);
        color: white;
      }
      
      .btn-success-mobile {
        background: var(--success);
        color: white;
      }
      
      .btn-delivered-mobile {
        background: #22c55e;
        color: white;
      }
      
      .btn-disabled-mobile {
        background: var(--muted);
        color: var(--fg);
        opacity: 0.6;
        cursor: not-allowed;
      }
      
      /* Header and filters mobile optimization */
      .order-header-section {
        flex-direction: column !important;
        gap: 12px !important;
        align-items: stretch !important;
      }
      
      .header-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      
      /* Tab navigation improvements */
      .tabs {
        margin-bottom: 16px;
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
      
      .tab-btn {
        min-width: 80px;
        padding: 8px 16px;
        font-size: 13px;
        flex-shrink: 0;
      }
      
      /* Main layout adjustments */
      main {
        padding: 8px !important;
        margin: 0 !important;
        max-width: 100vw;
        overflow-x: hidden;
      }
      
      .card {
        margin: 0 0 16px 0 !important;
        padding: 16px !important;
        border-radius: 12px;
      }
      
      /* Hide desktop table on mobile */
      .desktop-table {
        display: none !important;
      }
    }
    
    /* Desktop - hide mobile cards */
    @media (min-width: 769px) {
      .mobile-orders {
        display: none !important;
      }
      
      .desktop-table {
        display: table !important;
      }
      
      /* Reset mobile header styles for desktop */
      .order-header-section {
        flex-direction: row !important;
        align-items: center !important;
      }
      
      .header-title-row {
        flex: 1;
        justify-content: space-between;
      }
      
      .filters-mobile {
        display: flex !important;
        flex-direction: row !important;
        gap: 12px !important;
        align-items: center;
        margin-bottom: 16px !important;
      }
      
      .filters-mobile input {
        flex: 1 !important;
        min-width: 200px !important;
        width: auto !important;
        margin-bottom: 0 !important;
        padding: 8px !important;
        background: #0e1a30 !important;
      }
      
      .filters-mobile select {
        width: auto !important;
        flex: none !important;
        margin-bottom: 0 !important;
        padding: 8px !important;
        background: #0e1a30 !important;
      }
    }
    
    /* General action button styles */
    .action-btn {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--accent);
      color: white;
      text-align: center;
      max-width: 150px;
      box-sizing: border-box;
    }
    
    .action-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: var(--muted);
    }
    
    .btn-delivery {
      background: #ff6b35;
      color: white;
    }
    
    .btn-delivery:hover:not(:disabled) {
      background: #e55a2b;
    }
    
    .btn-delivered {
      background: #22c55e;
      color: white;
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
    .status-fulfilled { background: #e8f5e8; color: #4caf50; }
    .status-delivered { background: #dcfce7; color: #22c55e; }
    .order-items {
      max-width: 250px;
      font-size: 12px;
      color: #666;
    }
    .order-date {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
<header>
  <div class="header-brand">
    <h1>WMS Yönetim Sistemi</h1>
    <span class="header-subtitle">Teslimat Kanıtı</span>
  </div>
  <div class="header-actions">
    <a href="/index.html" class="home-btn">
      <span class="home-icon">🏠</span>
      <span class="home-text">Ana Sayfa</span>
    </a>
  </div>
</header>

<main class="grid" style="max-width:1200px;margin:auto;padding:16px">
  <section class="card">
    <div class="flex order-header-section" style="justify-content:space-between;align-items:center;margin-bottom:16px">
      <div class="header-title-row">
        <h2>Teslimat Kanıtı</h2>
        <div class="header-actions">
          <span class="badge" id="deliveryStatus"></span>
        </div>
      </div>
    </div>

    <!-- Filtre ve Arama -->
    <div class="filters-mobile">
      <input type="text" id="searchInput" placeholder="Sipariş no veya müşteri adı ara...">
      <select id="statusFilter">
        <option value="all">Tüm Durumlar</option>
        <option value="pending" selected>Teslimat Bekleyen</option>
        <option value="delivered">Teslim Edildi</option>
      </select>
    </div>

    <!-- Sekmeler -->
    <div class="tabs" style="margin-bottom:16px">
      <button class="tab-btn active" data-tab="pending">Teslimat Bekleyen (<span id="pendingCount">0</span>)</button>
      <button class="tab-btn" data-tab="delivered">Teslim Edildi (<span id="deliveredCount">0</span>)</button>
    </div>

    <!-- Sipariş Tablosu - Desktop -->
    <div class="table-container desktop-table">
      <table id="deliveryTable">
        <thead>
          <tr>
            <th>Sipariş No</th>
            <th>Müşteri</th>
            <th>Durum</th>
            <th>Kalemler</th>
            <th>Tarih</th>
            <th>İşlem</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- Sipariş Cards - Mobile -->
    <div class="mobile-orders" style="display: none;">
      <div id="mobileOrderList"></div>
    </div>
  </section>
</main>

<script type="module">
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

const API = {
  listDeliveryOrders: () => {
    console.log('🌐 Fetching delivery orders...');
    return fetch('/api/deliveries/orders').then(r => {
      console.log('📡 Response status:', r.status);
      return r.json();
    }).catch(error => {
      console.error('🚨 API Error:', error);
      throw error;
    });
  },
  createDelivery: (orderId) => fetch('/api/deliveries', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ order_id: orderId })
  }).then(r => r.json()),
  getDeliveryRecords: (orderId) => {
    console.log('📋 Fetching delivery records for order:', orderId);
    return fetch(`/api/orders/${orderId}/delivery-records`).then(r => r.json());
  }
};

// Global state
let allOrders = [];
let currentTab = 'pending';
let searchTerm = '';
let statusFilter = 'pending';

// Müşteri adını temizleme fonksiyonu
function cleanCustomerName(customerName) {
  if (!customerName || customerName === '-') return 'Bilinmeyen Müşteri';
  
  const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (uuidPattern.test(customerName)) {
    return customerName; // UUID'yi olduğu gibi döndür
  }
  
  return customerName;
}

// Durum bazında siparişleri kategorize et
function categorizeOrder(order) {
  console.log('🔍 Categorizing order:', order.id, 'delivery_status:', order.delivery_status, 'fulfillment_status:', order.fulfillment_status);
  
  if (order.delivery_status === 'delivered') {
    console.log('✅ Order', order.id, 'categorized as delivered');
    return 'delivered';
  }
  
  // Tamamlanmış ama henüz teslimat başlatılmamış
  if (order.fulfillment_status === 'FULFILLED') {
    console.log('⏳ Order', order.id, 'categorized as pending');
    return 'pending';
  }
  
  // Diğer durumlar gösterilmez
  console.log('❌ Order', order.id, 'not categorized');
  return null;
}

// Siparişleri yükle - Sadece FULFILLED olanlar
async function loadOrders() {
  try {
    console.log('🔄 Loading delivery orders from API...');
    const response = await API.listDeliveryOrders();
    console.log('📦 Delivery orders loaded:', response?.length || 0, 'orders');
    allOrders = response || [];
    
    updateCounts();
    filterAndDisplayOrders();
    console.log('✅ Delivery orders display updated');
  } catch (error) {
    console.error('❌ Error loading delivery orders:', error);
    allOrders = [];
    updateCounts();
    filterAndDisplayOrders();
  }
}

// Sayaç güncellemeleri
function updateCounts() {
  const pendingCount = allOrders.filter(o => categorizeOrder(o) === 'pending').length;
  const deliveredCount = allOrders.filter(o => categorizeOrder(o) === 'delivered').length;
  
  $('#pendingCount').textContent = pendingCount;
  $('#deliveredCount').textContent = deliveredCount;
}

// Siparişleri filtrele ve göster
function filterAndDisplayOrders() {
  let filteredOrders = [];
  
  console.log('🔄 Filtering orders for tab:', currentTab);
  console.log('📋 All orders:', allOrders.length);
  
  if (currentTab === 'pending') {
    filteredOrders = allOrders.filter(o => categorizeOrder(o) === 'pending');
    console.log('⏳ Pending filtered:', filteredOrders.length);
  } else if (currentTab === 'delivered') {
    filteredOrders = allOrders.filter(o => categorizeOrder(o) === 'delivered');
    console.log('✅ Delivered filtered:', filteredOrders.length);
  }
  
  // Durum filtresi - sadece 'all' seçiliyse uygula
  console.log('🔧 Status filter:', statusFilter);
  if (statusFilter !== 'all') {
    console.log('⚠️ Status filter active, before:', filteredOrders.length);
    if (statusFilter === 'pending') {
      filteredOrders = filteredOrders.filter(o => categorizeOrder(o) === 'pending');
    } else if (statusFilter === 'delivered') {
      filteredOrders = filteredOrders.filter(o => categorizeOrder(o) === 'delivered');
    }
    console.log('⚠️ Status filter after:', filteredOrders.length);
  }
  
  // Arama filtresi
  if (searchTerm.trim()) {
    const term = searchTerm.toLowerCase().trim();
    filteredOrders = filteredOrders.filter(o => {
      const customerDisplay = o.cariIsmi || o.cari_ismi || o.customer_name || o.customer_code || '';
      const cleanedCustomerName = cleanCustomerName(customerDisplay);
      return o.order_number.toLowerCase().includes(term) ||
             cleanedCustomerName.toLowerCase().includes(term);
    });
  }
  
  displayOrders(filteredOrders);
}

// Siparişleri tabloda göster
function displayOrders(orders) {
  const tbody = $('#deliveryTable tbody');
  
  console.log('🖥️ Displaying orders:', orders.length, 'for tab:', currentTab);
  orders.forEach(o => {
    console.log('  Order', o.id, '- Category:', categorizeOrder(o));
  });
  
  if (orders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#666">Teslimat siparişi bulunamadı</td></tr>';
    return;
  }
  
  // Sipariş numarasına göre büyükten küçüğe sırala
  const sortedOrders = [...orders].sort((a, b) => {
    const orderA = parseInt(a.order_number) || 0;
    const orderB = parseInt(b.order_number) || 0;
    return orderB - orderA;
  });
  
  // Desktop table rendering
  tbody.innerHTML = sortedOrders.map(o => {
    const items = o.items || [];
    const count = items.length;
    
    let itemDetails = '';
    if (count === 0) {
      itemDetails = '<span style="color:#999;font-style:italic;">Sipariş kalemleri yükleniyor...</span>';
    } else {
      itemDetails = items.map(item => {
        const productName = (item.product_name || item.sku || item.product_sku || 'Ürün adı yok');
        const displayName = productName.length > 30 
          ? productName.substring(0, 30) + '...'
          : productName;
        
        let colorInfo = '';
        if (item.product_color && item.product_color.trim()) {
          const color = item.product_color.trim();
          colorInfo = ` <span style="color:#fff;background:#666;padding:2px 6px;border-radius:3px;font-size:10px;">${color}</span>`;
        }
        
        const quantity = item.quantity || item.miktar || 1;
        
        return `• ${displayName}${colorInfo} x${quantity}`;
      }).slice(0, 3).join('<br>') + (items.length > 3 ? '<br>+ ' + (items.length - 3) + ' kalem daha...' : '');
    }
    
    // Müşteri ismi öncelikli gösterim
    const customerDisplay = o.cariIsmi || o.cari_ismi || o.customer_name || o.customer_code || 'Bilinmeyen Müşteri';
    const rawCustomerName = cleanCustomerName(customerDisplay);
    const displayCustomerName = rawCustomerName && rawCustomerName.length > 25 
      ? rawCustomerName.substring(0, 25) + '...'
      : rawCustomerName;
    
    // Durum class ve text belirleme
    let statusClass, statusText;
    
    if (o.delivery_status === 'delivered') {
      statusClass = 'status-delivered';
      statusText = 'Teslim Edildi';
    } else {
      statusClass = 'status-fulfilled';
      statusText = 'Teslimat Bekliyor';
    }
    
    // Tarih formatlaması - Belçika saati
    const orderDate = new Date(o.created_at).toLocaleDateString('tr-TR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'Europe/Brussels'
    });
    
    // Action button
    let actionBtn;
    
    if (o.delivery_status === 'delivered') {
      actionBtn = `<button class="action-btn btn-delivered" data-delivery-records="${o.id}" title="Teslimat kayıtlarını görüntüle">📋 Teslimat Kayıtları</button>`;
    } else {
      actionBtn = `<button class="action-btn btn-delivery" data-delivery-start="${o.id}" title="Teslimat başlat">🚚 Teslimat Başlat</button>`;
    }
    
    return `<tr>
      <td data-label="Sipariş No"><strong>#${o.order_number}</strong></td>
      <td data-label="Müşteri">${displayCustomerName}</td>
      <td data-label="Durum"><span class="status-badge ${statusClass}">${statusText}</span></td>
      <td data-label="Kalemler"><div class="order-items">${count} kalem<br>${itemDetails}</div></td>
      <td data-label="Tarih"><div class="order-date">${orderDate}</div></td>
      <td data-label="İşlem">${actionBtn}</td>
    </tr>`;
  }).join('');
  
  // Mobile card rendering
  const mobileOrderList = document.getElementById('mobileOrderList');
  if (mobileOrderList) {
    mobileOrderList.innerHTML = sortedOrders.map(o => {
      const items = o.items || [];
      const count = items.length;
      
      let itemDetails = '';
      if (count === 0) {
        itemDetails = 'Sipariş kalemleri yükleniyor...';
      } else {
        itemDetails = items.map(item => {
          const productName = (item.product_name || item.sku || item.product_sku || 'Ürün adı yok');
          const displayName = productName.length > 40 
            ? productName.substring(0, 40) + '...'
            : productName;
            
          let colorInfo = '';
          if (item.product_color && item.product_color.trim()) {
            colorInfo = ` (${item.product_color.trim()})`;
          }
          
          const quantity = item.quantity || item.miktar || 1;
          
          return `• ${displayName}${colorInfo} x${quantity}`;
        }).slice(0, 2).join('\n') + (items.length > 2 ? '\n+ ' + (items.length - 2) + ' kalem daha...' : '');
      }
      
      // Mobile için müşteri ismi
      const customerDisplay = o.cariIsmi || o.cari_ismi || o.customer_name || o.customer_code || 'Bilinmeyen Müşteri';
      const rawCustomerName = cleanCustomerName(customerDisplay);
      const displayCustomerName = rawCustomerName && rawCustomerName.length > 30 
        ? rawCustomerName.substring(0, 30) + '...'
        : rawCustomerName;
      
      // Status badge for mobile
      let statusClass, statusText;
      if (o.delivery_status === 'delivered') {
        statusClass = 'btn-delivered-mobile';
        statusText = 'Teslim Edildi';
      } else {
        statusClass = 'btn-primary-mobile';
        statusText = 'Teslimat Bekliyor';
      }
      
      // Date formatting - Belçika saati
      const orderDate = new Date(o.created_at).toLocaleDateString('tr-TR', {
        day: '2-digit',
        month: '2-digit', 
        year: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'Europe/Brussels'
      });
      
      // Mobile action button
      let mobileBtn, btnClass = 'mobile-action-btn';
      if (o.delivery_status === 'delivered') {
        btnClass += ' btn-delivered-mobile';
        mobileBtn = `<button class="${btnClass}" data-delivery-records="${o.id}">📋 Teslimat Kayıtları</button>`;
      } else {
        btnClass += ' btn-primary-mobile';
        mobileBtn = `<button class="${btnClass}" data-delivery-start="${o.id}">🚚 Teslimat Başlat</button>`;
      }
      
      return `
        <div class="order-card">
          <div class="order-header">
            <div class="order-number">#${o.order_number}</div>
            <div class="order-status ${statusClass.replace('mobile', 'badge')}">${statusText}</div>
          </div>
          
          <div class="order-info">
            <div class="info-row">
              <div class="info-label">Müşteri:</div>
              <div class="info-value"><strong>${displayCustomerName}</strong></div>
            </div>
            <div class="info-row">
              <div class="info-label">Tarih:</div>
              <div class="info-value">${orderDate}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Kalemler:</div>
              <div class="info-value">${count} kalem</div>
            </div>
          </div>
          
          <div class="order-items-mobile">
            ${itemDetails}
          </div>
          
          ${mobileBtn}
        </div>
      `;
    }).join('');
  }
}

// Event listeners
document.body.addEventListener('click', async (e) => {
  
  // Sekme değiştirme
  if (e.target.classList.contains('tab-btn')) {
    $$('.tab-btn').forEach(btn => btn.classList.remove('active'));
    e.target.classList.add('active');
    currentTab = e.target.dataset.tab;
    
    // Tab değiştiğinde status filter'ı otomatik güncelle
    const statusFilterSelect = $('#statusFilter');
    if (currentTab === 'pending') {
      statusFilterSelect.value = 'pending';
      statusFilter = 'pending';
    } else if (currentTab === 'delivered') {
      statusFilterSelect.value = 'delivered';
      statusFilter = 'delivered';
    }
    
    filterAndDisplayOrders();
  }
  
  // Teslimat başlatma
  const deliveryStartValue = e.target.getAttribute('data-delivery-start');
  if (deliveryStartValue) {
    console.log('Starting delivery for order:', deliveryStartValue);
    // Direkt teslimat verify sayfasına yönlendir
    location.href = '/delivery-verify.html?order=' + deliveryStartValue;
  }
  
  // Teslimat kayıtları görüntüleme
  const deliveryRecordsValue = e.target.getAttribute('data-delivery-records');
  if (deliveryRecordsValue) {
    console.log('Showing delivery records for order:', deliveryRecordsValue);
    showDeliveryRecordsModal(deliveryRecordsValue);
  }
});

// Teslimat kayıtları modal fonksiyonu
async function showDeliveryRecordsModal(orderId) {
  try {
    const data = await API.getDeliveryRecords(orderId);
    
    // Modal HTML oluştur
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 16px;
    `;
    
    const content = document.createElement('div');
    content.style.cssText = `
      background: var(--bg);
      border-radius: 12px;
      padding: 24px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    `;
    
    const order = allOrders.find(o => o.id == orderId);
    const customerName = order ? (order.cariIsmi || order.customer_name || 'Bilinmeyen Müşteri') : 'Bilinmeyen Müşteri';
    
    content.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>📋 Teslimat Kayıtları</h2>
        <button onclick="closeDeliveryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);">×</button>
      </div>
      
      <div style="background: var(--hover); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div><strong>Sipariş No:</strong> #${order?.order_number || 'N/A'}</div>
          <div><strong>Müşteri:</strong> ${customerName}</div>
          <div><strong>Teslimat Tarihi:</strong> ${data.delivery ? new Date(data.delivery.delivered_at || data.delivery.created_at).toLocaleDateString('tr-TR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Europe/Brussels'
          }) : 'N/A'}</div>
          <div><strong>Durum:</strong> <span style="color: var(--success);">✅ Teslim Edildi</span></div>
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3>📦 Teslim Edilen Ürünler</h3>
        <div style="background: var(--card); border-radius: 8px; overflow: hidden;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--hover);">
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border);">SKU</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border);">Ürün</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border);">Paket Sayısı</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border);">Toplam Miktar</th>
                <th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border);">Teslimat Zamanı</th>
              </tr>
            </thead>
            <tbody>
              ${data.scans && data.scans.length > 0 ? data.scans.map(scan => `
                <tr>
                  <td style="padding: 12px; border-bottom: 1px solid var(--border);"><code>${scan.sku || 'N/A'}</code></td>
                  <td style="padding: 12px; border-bottom: 1px solid var(--border);">
                    <div>${scan.product_name || scan.sku || 'N/A'}</div>
                    ${scan.product_color ? `<div style="font-size: 11px; color: var(--muted); margin-top: 2px;">Renk: ${scan.product_color}</div>` : ''}
                  </td>
                  <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">
                    <span style="background: var(--success); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                      ${scan.total_packages_scanned} paket
                    </span>
                  </td>
                  <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;">
                    <strong>${scan.total_quantity || scan.total_packages_scanned}</strong>
                  </td>
                  <td style="padding: 12px; border-bottom: 1px solid var(--border);">
                    ${scan.first_scan_time ? new Date(scan.first_scan_time).toLocaleDateString('tr-TR', {
                      day: '2-digit',
                      month: '2-digit',
                      hour: '2-digit',
                      minute: '2-digit',
                      timeZone: 'Europe/Brussels'
                    }) : 'N/A'}
                    ${scan.last_scan_time && scan.first_scan_time !== scan.last_scan_time ? 
                      `<div style="font-size: 11px; color: var(--muted); margin-top: 2px;">
                        Son: ${new Date(scan.last_scan_time).toLocaleDateString('tr-TR', {
                          hour: '2-digit',
                          minute: '2-digit',
                          timeZone: 'Europe/Brussels'
                        })}
                      </div>` : ''}
                  </td>
                </tr>
              `).join('') : `
                <tr>
                  <td colspan="5" style="padding: 20px; text-align: center; color: var(--muted);">Teslimat kaydı bulunamadı</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
      </div>
      
      ${data.delivery?.delivery_notes ? `
        <div style="margin-bottom: 20px;">
          <h3>📝 Teslimat Notları</h3>
          <div style="background: var(--hover); padding: 12px; border-radius: 8px;">
            ${data.delivery.delivery_notes}
          </div>
        </div>
      ` : ''}
      
      ${data.delivery?.customer_signature ? `
        <div style="margin-bottom: 20px;">
          <h3>✍️ Müşteri İmzası</h3>
          <div style="background: white; border-radius: 8px; padding: 12px;">
            <img src="${data.delivery.customer_signature}" alt="Müşteri İmzası" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px;">
          </div>
        </div>
      ` : ''}
      
      <div style="margin-top: 24px; text-align: center;">
        <button onclick="closeDeliveryModal()" style="background: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">Kapat</button>
      </div>
    `;
    
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    // Global referans
    window.currentDeliveryModal = modal;
    
  } catch (error) {
    console.error('Delivery records error:', error);
    alert('❌ Teslimat kayıtları yüklenirken hata oluştu: ' + error.message);
  }
}

// Modal kapatma fonksiyonu
window.closeDeliveryModal = () => {
  if (window.currentDeliveryModal) {
    document.body.removeChild(window.currentDeliveryModal);
    window.currentDeliveryModal = null;
  }
};

// Arama input
$('#searchInput').addEventListener('input', (e) => {
  searchTerm = e.target.value;
  filterAndDisplayOrders();
});

// Durum filtresi
$('#statusFilter').addEventListener('change', (e) => {
  statusFilter = e.target.value;
  filterAndDisplayOrders();
});

// Load orders
await loadOrders();

// Otomatik yenileme - her 30 saniyede bir
setInterval(async () => {
  console.log('🔄 Auto-refreshing delivery orders...');
  await loadOrders();
}, 30000);

// Sayfa odaklandığında yenile
document.addEventListener('visibilitychange', async () => {
  if (!document.hidden) {
    console.log('👁️ Page became visible - refreshing delivery orders');
    await loadOrders();
  }
});
</script>
</body>
</html>